var _0x1354=['onlyStudyIds','forEach','push','getStudy','studies/','getChanges','since','limit','&limit=','changes','getResourcesByStudyId','SeriesIds','InstancesIds','Instances','Series','getMd5byInstanceId','/attachments/dicom/md5','/attachments/dicom-as-json/data','getOrCache\x20-\x20','\x20-\x20','allowLogging','fatal','debug','info','green','magenta','yellow','dbName','instance','genMongConnString','connString','mongodb://','password','host','port','?replSet=','dontUserDBForAuth','/?replSet=','replSetName','MONGO_URL','mongodb://localhost:27017','client','MongoClient','isConnected','connect','Mongo\x20Connectado\x20com\x20Sucesso','close','getCollection','collection','getCollection\x20Isso','otRestSvc','mongoDataService','getOrthancStreamCollection','OrthancChangeStream_','createIndex','getInstancesCol','Instances_','Series_','getIndexBatchCol','IndexBatch_','PrometheusMetrics_','getGenericCol','createInstance','Collections','OrthancRestClientInstance','Got\x20-\x20OrthancRestClientInstance','MongoServiceInstance','MONGO_DB_NAME','setMongoDBConnString','getChangeStream','toArray','find','saveDataToDB','isArray','OrthancServerURL','_id','updateOne','insertOne','isObject','Data\x20provided\x20is\x20not\x20an\x20Object\x20not\x20an\x20Array','getStableNewStudies','NewStudy','getDataTraceByStudy','getDataTraceByStudySummary','studyId','InstitutionName','ReferringPhysicianName','RequestedProcedureDescription','RequestingPhysician','StudyDescription','StudyID','StudyTime','ParentPatient','PatientMainDicomTags','PatientID','PatientName','PatientSex','ParentStudy','IsStable','Status','BodyPartExamined','Manufacturer','Modality','StationName','PerformedProcedureStepDescription','SeriesDescription','SeriesDate','SeriesInstanceUID','getDataTraceByStudyResourcesListUIDS','getStudyRelatedInstancesMd5','Parameter\x20not\x20provided','getStudyRelatedInstances','withServerInfo','studyUID','getStudySize','FileSize','\x20Bytes','\x20KB','toFixed','\x20MB','\x20GB','_getOrthancNodeBaseURL','stringify','getInstanceInfo','createInstances','OrthancServers','compareNewAndStableStudies','chain','uniq','indexOf','http://','parse','getTime','orthancRestBaseURL','MongoConfig','getOrthancRestInstanceInfo','addMissing','startFrom','missing\x20parameters','Changes','Seq','Date','Path','ResourceType','indexChangeStream','resumeIndexing','Starting\x20from\x20','getNextSeq','INFO','success','\x20LoopCount\x20','\x20-\x20Documents\x20Inserted:\x20','vou\x20continuar\x20em\x201500ms','validateMissingSeqs','missingSeqs','lastSeq','getLastIndexedChangeStreamSeq','sort','indexStableStudies','StableStudy','indexChangeItem','ChangeType','assign','insertNewItem','project','reduce','insertDocument','hasNext','E11000\x20duplicate\x20key\x20error\x20collection','ID\x20-\x20','\x20added','Key\x20','\x20at\x20OrthancChangeStream\x20is\x20duplicated\x20-\x20Skipping','keys','Done','path','prettyStream','createWriteStream','/tmp/info.stream.out','error','/tmp/error.stream.out','/tmp/fatal.stream.out','getLogger','check','isOrthancServversOnLine','load','OrthancRestClientInstances','OrthancDataServiceInstances','createOrthancDataServiceInstances','loadAndIndex','createOrthancDataIndexService','runIndexAllServers','createOrthancRestClientInstances','getListOfStudiesAllServers','concat','Servers:','join','indexInstances','NewInstance','getDicomasJsonByInstanceId','entries','Name','date','AccessionNumber','missing','\x20of\x20','end','count','getPrometheusMetrics','appendToFile','appendFile','FileUtils','LogginService','MongoDBService','OrthancDataService','OrthancRestClient','default','defineProperty','__esModule','node-cache','is-reachable','signale','prettyjson','mongodb','lodash','throw','done','value','apply','next','dotenv-defaults','config','options','requestCache','baseURL','timeout','headers','restClientInstance','create','get','endPoint','string','log','useCache','set','status','statusText','data','orthancBaseURL','env','ORTHANC_BASE_URL','http://localhost','foobar','restClient','DEBUG','getBaseURLInfo','getServerAndPort','split','length','getInstancesIds','getOrCache','instances','tools/metrics-prometheus','message','getInstance','instances/','trim','msg','getSeriesIds','series','getSerie','hasOwnProperty','series/','getStudiesIds','getStudies','map','MainDicomTags','StudyInstanceUID','onlyStudyInstanceUID'];(function(_0x37c2c9,_0x4ff3d6){var _0x10f22d=function(_0x297385){while(--_0x297385){_0x37c2c9['push'](_0x37c2c9['shift']());}};_0x10f22d(++_0x4ff3d6);}(_0x1354,0xd8));var _0x2dbb=function(_0x2f3e31,_0x3a89c9){_0x2f3e31=_0x2f3e31-0x0;var _0x2c6db2=_0x1354[_0x2f3e31];return _0x2c6db2;};'use strict';function e(_0x24e1e7){return _0x24e1e7&&'object'==typeof _0x24e1e7&&_0x2dbb('0x0')in _0x24e1e7?_0x24e1e7[_0x2dbb('0x0')]:_0x24e1e7;}Object[_0x2dbb('0x1')](exports,_0x2dbb('0x2'),{'value':!0x0});var t=e(require('axios')),n=e(require(_0x2dbb('0x3'))),s=e(require(_0x2dbb('0x4'))),r=e(require(_0x2dbb('0x5'))),i=e(require(_0x2dbb('0x6'))),o=require(_0x2dbb('0x7')),c=require(_0x2dbb('0x8')),a=e(c),d=require('date-fns'),l=e(require('md5')),h=e(require('fs'));function u(_0x1ec02b,_0x8569a,_0x2758d0,_0x2f4a62){return new(_0x2758d0||(_0x2758d0=Promise))(function(_0x53ed7d,_0x874668){function _0x464db1(_0x1ec02b){try{_0x2593ed(_0x2f4a62['next'](_0x1ec02b));}catch(_0x1f3d38){_0x874668(_0x1f3d38);}}function _0xae2c2f(_0x1ec02b){try{_0x2593ed(_0x2f4a62[_0x2dbb('0x9')](_0x1ec02b));}catch(_0xd2e5e1){_0x874668(_0xd2e5e1);}}function _0x2593ed(_0x1ec02b){_0x1ec02b[_0x2dbb('0xa')]?_0x53ed7d(_0x1ec02b[_0x2dbb('0xb')]):new _0x2758d0(function(_0x8569a){_0x8569a(_0x1ec02b[_0x2dbb('0xb')]);})['then'](_0x464db1,_0xae2c2f);}_0x2593ed((_0x2f4a62=_0x2f4a62[_0x2dbb('0xc')](_0x1ec02b,_0x8569a||[]))[_0x2dbb('0xd')]());});}require(_0x2dbb('0xe'))[_0x2dbb('0xf')]();class g{constructor(_0x350869){this['requestCache']=null,this[_0x2dbb('0x10')]=null,this[_0x2dbb('0x11')]=new n({'stdTTL':0x1f4,'checkperiod':0x208});const _0x3bd9bd={};_0x350869[_0x2dbb('0x12')]&&(_0x3bd9bd[_0x2dbb('0x12')]=_0x350869['baseURL']),_0x350869[_0x2dbb('0x13')]&&(_0x3bd9bd['timeout']=_0x350869['timeout']),_0x350869[_0x2dbb('0x14')]&&(_0x3bd9bd['headers']=_0x350869['headers']),this[_0x2dbb('0x15')]=t[_0x2dbb('0x16')](_0x3bd9bd),this[_0x2dbb('0x10')]=_0x3bd9bd;}[_0x2dbb('0xf')](){return this[_0x2dbb('0x10')];}[_0x2dbb('0x17')](_0x103862){return u(this,void 0x0,void 0x0,function*(){const _0x1ce5d5=_0x103862[_0x2dbb('0x18')]||_0x103862;try{if(_0x2dbb('0x19')!=typeof _0x103862&&_0x103862['options']['useCache']){console[_0x2dbb('0x1a')]('using\x20Cache');const _0x103862=this[_0x2dbb('0x11')][_0x2dbb('0x17')](_0x1ce5d5);if(_0x103862)return _0x103862;}const _0x52d3b7=yield this[_0x2dbb('0x15')][_0x2dbb('0x17')](_0x1ce5d5);return'string'!=typeof _0x103862&&!0x0===_0x103862[_0x2dbb('0x10')][_0x2dbb('0x1b')]&&this[_0x2dbb('0x11')][_0x2dbb('0x1c')](_0x1ce5d5,{'status':_0x52d3b7[_0x2dbb('0x1d')],'statusText':_0x52d3b7[_0x2dbb('0x1e')],'data':_0x52d3b7[_0x2dbb('0x1f')]}),_0x52d3b7;}catch(_0x2b15ac){throw new Error(_0x2b15ac);}});}}class S{constructor(_0x214899){this[_0x2dbb('0x20')]='';const _0x35786f={'baseURL':(_0x214899&&_0x214899[_0x2dbb('0x20')]?_0x214899['orthancBaseURL']:void 0x0)||process[_0x2dbb('0x21')][_0x2dbb('0x22')]||_0x2dbb('0x23'),'timeout':0xfa0,'headers':{'X-Custom-Header':_0x2dbb('0x24')}};this[_0x2dbb('0x25')]=new g(_0x35786f),this['orthancBaseURL']=_0x35786f[_0x2dbb('0x12')],process[_0x2dbb('0x21')][_0x2dbb('0x26')]&&console[_0x2dbb('0x1a')]('OrthancRestClient\x20-',_0x35786f['baseURL']);}[_0x2dbb('0x27')](){return this['orthancBaseURL'];}[_0x2dbb('0x28')](){const _0x157c56=this[_0x2dbb('0x27')]()[_0x2dbb('0x29')]('http://');let _0x593f1e=_0x157c56[0x0];return _0x157c56[_0x2dbb('0x2a')]>0x0&&(_0x593f1e=_0x157c56[0x1]),_0x593f1e;}[_0x2dbb('0x2b')](){return u(this,void 0x0,void 0x0,function*(){let _0x4451dc=null;try{return(_0x4451dc=yield this[_0x2dbb('0x2c')](_0x2dbb('0x2d')))[_0x2dbb('0x1f')];}catch(_0x4c7ab5){throw _0x4c7ab5;}});}['getPrometheusMetrics'](){return u(this,void 0x0,void 0x0,function*(){try{return(yield this[_0x2dbb('0x2c')](_0x2dbb('0x2e')))['data'];}catch(_0x2406f8){throw new Error(_0x2406f8['msg']||_0x2406f8[_0x2dbb('0x2f')]||_0x2406f8);}});}[_0x2dbb('0x30')](_0x5b8af9,_0x4c258b){return u(this,void 0x0,void 0x0,function*(){const _0x306b02=!_0x4c258b||!_0x4c258b['hasOwnProperty'](_0x2dbb('0x1b'))||_0x4c258b['useCache'];try{return(yield this['getOrCache'](_0x2dbb('0x31')+_0x5b8af9[_0x2dbb('0x32')](),_0x306b02))['data'];}catch(_0x1e1b5d){throw new Error(_0x1e1b5d[_0x2dbb('0x33')]||_0x1e1b5d['message']||_0x1e1b5d);}});}[_0x2dbb('0x34')](){return u(this,void 0x0,void 0x0,function*(){try{return(yield this[_0x2dbb('0x2c')](_0x2dbb('0x35')))[_0x2dbb('0x1f')];}catch(_0x34b1c9){throw _0x34b1c9;}});}[_0x2dbb('0x36')](_0x5d67c6,_0x1770b1){return u(this,void 0x0,void 0x0,function*(){const _0x2dcbaa=!_0x1770b1||!_0x1770b1[_0x2dbb('0x37')](_0x2dbb('0x1b'))||_0x1770b1[_0x2dbb('0x1b')];try{return(yield this[_0x2dbb('0x2c')](_0x2dbb('0x38')+_0x5d67c6[_0x2dbb('0x32')](),_0x2dcbaa))[_0x2dbb('0x1f')];}catch(_0x3ecafe){throw _0x3ecafe;}});}[_0x2dbb('0x39')](){return u(this,void 0x0,void 0x0,function*(){try{return(yield this[_0x2dbb('0x2c')]('studies'))['data'];}catch(_0x5ac494){throw _0x5ac494;}});}[_0x2dbb('0x3a')](_0x288489){return u(this,void 0x0,void 0x0,function*(){try{const _0x38e380=yield this[_0x2dbb('0x39')](),_0x3425f6=[];for(const _0x288489 of _0x38e380)_0x3425f6['push'](yield this['getOrCache']('studies/'+_0x288489));const _0x121e32=_0x3425f6[_0x2dbb('0x3b')](_0x288489=>void 0x0!==_0x288489&&_0x288489['data']?_0x288489['data']:[]),_0x3d0e6e=[]['concat'](..._0x121e32)[_0x2dbb('0x3b')](_0x288489=>!!_0x288489[_0x2dbb('0x3c')][_0x2dbb('0x3d')]&&_0x288489['MainDicomTags'][_0x2dbb('0x3d')]);if(_0x288489&&_0x288489[_0x2dbb('0x3e')])return _0x3d0e6e;if(_0x288489&&_0x288489[_0x2dbb('0x3f')])return _0x38e380;{let _0x288489=[];return _0x3d0e6e[_0x2dbb('0x40')]((_0x3425f6,_0x121e32)=>{_0x288489[_0x2dbb('0x41')]({'studyId':_0x38e380[_0x121e32],'studyUID':_0x3425f6});}),_0x288489;}}catch(_0x5a2483){throw _0x5a2483;}});}[_0x2dbb('0x42')](_0x659f65){return u(this,void 0x0,void 0x0,function*(){try{return(yield this[_0x2dbb('0x2c')](_0x2dbb('0x43')+_0x659f65[_0x2dbb('0x32')]()))[_0x2dbb('0x1f')];}catch(_0x26c3e5){throw _0x26c3e5;}});}[_0x2dbb('0x44')](_0x3e84ca=null){return u(this,void 0x0,void 0x0,function*(){try{let _0x5beed0='';_0x3e84ca&&null!==_0x3e84ca[_0x2dbb('0x45')]&&(_0x5beed0='?since='+_0x3e84ca[_0x2dbb('0x45')]),_0x3e84ca&&_0x3e84ca[_0x2dbb('0x46')]&&null!==_0x3e84ca[_0x2dbb('0x46')]&&(_0x5beed0=_0x5beed0+_0x2dbb('0x47')+_0x3e84ca['limit']);let _0x515664=yield this[_0x2dbb('0x2c')](_0x2dbb('0x48')+_0x5beed0,!0x1);return _0x515664=_0x515664[_0x2dbb('0x1f')];}catch(_0xe2e47a){throw _0xe2e47a;}});}[_0x2dbb('0x49')](_0x521e26){return u(this,void 0x0,void 0x0,function*(){if(_0x521e26)try{const _0x10cc37=(yield this[_0x2dbb('0x2c')](_0x2dbb('0x43')+_0x521e26))['data'];_0x10cc37[_0x2dbb('0x4a')]=_0x10cc37['Series'],_0x10cc37['Series']=[];for(let _0x521e26=0x0;_0x521e26<_0x10cc37['SeriesIds'][_0x2dbb('0x2a')];_0x521e26++){const _0x418084=_0x10cc37['SeriesIds'][_0x521e26],_0x3f0510=yield this[_0x2dbb('0x36')](_0x418084);if(_0x3f0510){_0x3f0510[_0x2dbb('0x4b')]=_0x3f0510[_0x2dbb('0x4c')],_0x3f0510['Instances']=[];const _0x521e26=_0x3f0510[_0x2dbb('0x4b')][_0x2dbb('0x2a')];for(let _0x10cc37=0x0;_0x10cc37<_0x521e26;_0x10cc37++){const _0x521e26=_0x3f0510[_0x2dbb('0x4b')][_0x10cc37],_0x418084=yield this[_0x2dbb('0x30')](_0x521e26);_0x3f0510[_0x2dbb('0x4c')][_0x2dbb('0x41')](_0x418084);}_0x10cc37[_0x2dbb('0x4d')]['push'](_0x3f0510);}}return _0x10cc37;}catch(_0x504356){throw new Error(_0x504356[_0x2dbb('0x33')]||_0x504356[_0x2dbb('0x2f')]||_0x504356);}});}[_0x2dbb('0x4e')](_0x5d68a9,_0x395b81){return u(this,void 0x0,void 0x0,function*(){const _0x337c0c=!_0x395b81||!_0x395b81[_0x2dbb('0x37')](_0x2dbb('0x1b'))||_0x395b81['useCache'];try{const _0x395b81=yield this[_0x2dbb('0x2c')](_0x2dbb('0x31')+_0x5d68a9+_0x2dbb('0x4f'),_0x337c0c);return _0x395b81[_0x2dbb('0x1f')]||_0x395b81;}catch(_0x2492bc){throw new Error(_0x2492bc[_0x2dbb('0x33')]||_0x2492bc[_0x2dbb('0x2f')]||_0x2492bc);}});}['getDicomasJsonByInstanceId'](_0x5e1a2e,_0x14aede){return u(this,void 0x0,void 0x0,function*(){const _0xd23e96=!_0x14aede||!_0x14aede[_0x2dbb('0x37')]('useCache')||_0x14aede[_0x2dbb('0x1b')];try{const _0x14aede=yield this[_0x2dbb('0x2c')](_0x2dbb('0x31')+_0x5e1a2e+_0x2dbb('0x50'),_0xd23e96);return _0x14aede[_0x2dbb('0x1f')]||_0x14aede;}catch(_0xa539e9){throw new Error(_0xa539e9[_0x2dbb('0x33')]||_0xa539e9[_0x2dbb('0x2f')]||_0xa539e9);}});}['getOrCache'](_0x2e5ef6,_0x2ee559=!0x0){return u(this,void 0x0,void 0x0,function*(){try{return yield this[_0x2dbb('0x25')][_0x2dbb('0x17')]({'endPoint':_0x2e5ef6,'options':{'useCache':_0x2ee559}});}catch(_0x3406cc){throw _0x3406cc['message']=_0x2dbb('0x51')+_0x2e5ef6+_0x2dbb('0x52')+_0x3406cc['message'],new Error(_0x3406cc);}});}}class y{constructor(){}static['success'](_0x5cd963){y[_0x2dbb('0x53')]&&r['success'](_0x5cd963);}static[_0x2dbb('0x54')](_0x758bdc){y[_0x2dbb('0x53')]&&r['fatal'](_0x758bdc);}static[_0x2dbb('0x55')](_0x279cdd){y[_0x2dbb('0x53')]&&r[_0x2dbb('0x55')](_0x279cdd);}static[_0x2dbb('0x56')](_0x15cc17){y[_0x2dbb('0x53')]&&r[_0x2dbb('0x56')](_0x15cc17);}static[_0x2dbb('0x6')](_0x46d11b){console[_0x2dbb('0x1a')](i['render'](_0x46d11b,{'keysColor':_0x2dbb('0x57'),'dashColor':_0x2dbb('0x58'),'stringColor':_0x2dbb('0x59')}));}}y[_0x2dbb('0x53')]=!0x0;class m{constructor(_0x367e7e){this['db']=null,this[_0x2dbb('0x5a')]='',this['client']=null,this[_0x2dbb('0x5a')]=_0x367e7e;}static['setMongoDBConnString'](_0x3c7a6d){process[_0x2dbb('0x21')]['MONGO_URL']=_0x3c7a6d;}static[_0x2dbb('0x30')](_0x54ce88){return m[_0x2dbb('0x5b')]['get'](_0x54ce88)||m[_0x2dbb('0x5b')][_0x2dbb('0x1c')](_0x54ce88,new m(_0x54ce88)),m[_0x2dbb('0x5b')][_0x2dbb('0x17')](_0x54ce88);}static[_0x2dbb('0x5c')](_0x466263){_0x466263[_0x2dbb('0x5d')]&&(_0x466263=_0x466263[_0x2dbb('0x5d')]);let _0x3aba3f=_0x2dbb('0x5e')+_0x466263['userName']+':'+_0x466263[_0x2dbb('0x5f')]+'@'+_0x466263[_0x2dbb('0x60')]+':'+_0x466263[_0x2dbb('0x61')]+'/'+_0x466263[_0x2dbb('0x5a')]+_0x2dbb('0x62')+_0x466263['replSetName'];return _0x466263[_0x2dbb('0x63')]&&(_0x3aba3f='mongodb://'+_0x466263['userName']+':'+_0x466263[_0x2dbb('0x5f')]+'@'+_0x466263[_0x2dbb('0x60')]+':'+_0x466263[_0x2dbb('0x61')]+_0x2dbb('0x64')+_0x466263[_0x2dbb('0x65')]),{'connString':_0x3aba3f,'dbName':_0x466263[_0x2dbb('0x5a')]};}['connect'](){return u(this,void 0x0,void 0x0,function*(){try{const _0xa519b1=process[_0x2dbb('0x21')][_0x2dbb('0x66')]||_0x2dbb('0x67');this[_0x2dbb('0x68')]=new o[(_0x2dbb('0x69'))](_0xa519b1,{'useNewUrlParser':!0x0}),!0x1===this[_0x2dbb('0x6a')]()&&(yield this[_0x2dbb('0x68')][_0x2dbb('0x6b')](),this['db']=this['client']['db'](this[_0x2dbb('0x5a')]),process[_0x2dbb('0x21')]['INFO']&&y[_0x2dbb('0x56')](_0x2dbb('0x6c')));}catch(_0x1a0778){throw new Error('MongoDb\x20nao\x20acessivel');}});}[_0x2dbb('0x6a')](){return!!this[_0x2dbb('0x68')]&&this['client'][_0x2dbb('0x6a')]();}[_0x2dbb('0x6d')](){return u(this,void 0x0,void 0x0,function*(){return yield this[_0x2dbb('0x68')][_0x2dbb('0x6d')]();});}[_0x2dbb('0x6e')](_0x50d10f){return u(this,void 0x0,void 0x0,function*(){try{return 0x0==this[_0x2dbb('0x6a')]()&&(yield this[_0x2dbb('0x6b')]()),this['db'][_0x2dbb('0x6f')](_0x50d10f);}catch(_0x317368){throw new Error(_0x2dbb('0x70'));}});}}m[_0x2dbb('0x5b')]=new Map();class v{constructor(_0x529672,_0x5d3f25){this[_0x2dbb('0x71')]=_0x529672,this[_0x2dbb('0x72')]=_0x5d3f25;}[_0x2dbb('0x73')](){return u(this,void 0x0,void 0x0,function*(){const _0x15ae4f=_0x2dbb('0x74')+this[_0x2dbb('0x71')][_0x2dbb('0x28')](),_0x4d8160=yield this[_0x2dbb('0x72')][_0x2dbb('0x6e')](_0x15ae4f);return _0x4d8160[_0x2dbb('0x75')]({'Seq':-0x1}),_0x4d8160['createIndex']({'ID':0x1}),_0x4d8160;});}[_0x2dbb('0x76')](){return u(this,void 0x0,void 0x0,function*(){const _0x57cab1=_0x2dbb('0x77')+this['otRestSvc']['getServerAndPort'](),_0x3612a7=yield this[_0x2dbb('0x72')][_0x2dbb('0x6e')](_0x57cab1);return _0x3612a7[_0x2dbb('0x75')]({'Seq':-0x1}),_0x3612a7['createIndex']({'AccessionNumber':0x1}),_0x3612a7;});}['getSeriesCol'](){return u(this,void 0x0,void 0x0,function*(){const _0x1c6c65=_0x2dbb('0x78')+this['otRestSvc'][_0x2dbb('0x28')](),_0x2d1fca=yield this[_0x2dbb('0x72')][_0x2dbb('0x6e')](_0x1c6c65);return _0x2d1fca['createIndex']({'Seq':-0x1}),_0x2d1fca;});}[_0x2dbb('0x79')](){return u(this,void 0x0,void 0x0,function*(){const _0x41a921=_0x2dbb('0x7a')+this[_0x2dbb('0x71')][_0x2dbb('0x28')]();return yield this[_0x2dbb('0x72')][_0x2dbb('0x6e')](_0x41a921);});}['getPrometheusMetricsCol'](){return u(this,void 0x0,void 0x0,function*(){const _0x59bffa=_0x2dbb('0x7b')+this[_0x2dbb('0x71')]['getServerAndPort']();return yield this[_0x2dbb('0x72')][_0x2dbb('0x6e')](_0x59bffa);});}[_0x2dbb('0x7c')](_0x1e029e){return u(this,void 0x0,void 0x0,function*(){const _0x56a7b2=_0x1e029e+'_'+this[_0x2dbb('0x71')][_0x2dbb('0x28')]();return yield this['mongoDataService'][_0x2dbb('0x6e')](_0x56a7b2);});}}class I{static[_0x2dbb('0x7d')](_0x2492bb,_0x116f2f){return new v(_0x2492bb,_0x116f2f);}}class f{constructor(_0x215b4e){this['mongoDataService']=null,this[_0x2dbb('0x7e')]=null,_0x215b4e&&_0x215b4e[_0x2dbb('0x7f')]?(_0x215b4e[_0x2dbb('0x7f')][_0x2dbb('0x20')]?this['otRestSvc']=new S({'orthancBaseURL':_0x215b4e[_0x2dbb('0x7f')][_0x2dbb('0x20')]}):this[_0x2dbb('0x71')]=_0x215b4e[_0x2dbb('0x7f')],process[_0x2dbb('0x21')][_0x2dbb('0x26')]&&console[_0x2dbb('0x1a')](_0x2dbb('0x80'))):this[_0x2dbb('0x71')]=new S(),_0x215b4e&&_0x215b4e[_0x2dbb('0x81')]?(this[_0x2dbb('0x72')]=_0x215b4e[_0x2dbb('0x81')],process['env'][_0x2dbb('0x26')]&&console['log']('Got\x20-\x20MongoServiceInstance')):this[_0x2dbb('0x72')]=m[_0x2dbb('0x30')](process[_0x2dbb('0x21')][_0x2dbb('0x82')]||'RISPACS'),this['Collections']=I[_0x2dbb('0x7d')](this[_0x2dbb('0x71')],this['mongoDataService']);}[_0x2dbb('0x83')](_0x29f6d2){process[_0x2dbb('0x21')]['MONGO_URL']=_0x29f6d2;}[_0x2dbb('0x84')](_0x4f48e9=null){return u(this,void 0x0,void 0x0,function*(){const _0xa47609=yield this['Collections'][_0x2dbb('0x73')]();return null===_0x4f48e9?yield _0xa47609['find']()[_0x2dbb('0x85')]():yield _0xa47609[_0x2dbb('0x86')](_0x4f48e9)[_0x2dbb('0x85')]();});}[_0x2dbb('0x87')](_0x1aa07e,_0x399924,_0x16a999){return u(this,void 0x0,void 0x0,function*(){try{let _0x525089=this['_getOrthancNodeBaseURL']();const _0x473d6b=yield this[_0x2dbb('0x7e')][_0x2dbb('0x7c')](_0x1aa07e);if(Array[_0x2dbb('0x88')](_0x399924)&&_0x399924[_0x2dbb('0x2a')]>0x0){_0x399924=_0x399924[_0x2dbb('0x3b')](_0x1aa07e=>(_0x1aa07e[_0x2dbb('0x89')]=_0x525089,_0x1aa07e['ts']=new Date(),_0x1aa07e)),_0x16a999&&(_0x399924=_0x399924[_0x2dbb('0x3b')](_0x1aa07e=>_0x1aa07e[_0x2dbb('0x8a')]=_0x1aa07e[_0x16a999]));for(const _0x1aa07e of _0x399924)_0x16a999?(_0x1aa07e[_0x2dbb('0x8a')]=_0x1aa07e[_0x16a999],yield _0x473d6b[_0x2dbb('0x8b')]({'_id':_0x1aa07e['_id']},{'$set':_0x1aa07e},{'upsert':!0x0})):yield _0x473d6b[_0x2dbb('0x8c')](_0x1aa07e);}else{if(!c[_0x2dbb('0x8d')](_0x399924))throw new Error(_0x2dbb('0x8e'));_0x399924['ts']=new Date(),_0x399924[_0x2dbb('0x89')]=_0x525089,_0x16a999?(_0x399924[_0x2dbb('0x8a')]=_0x399924[_0x16a999],yield _0x473d6b['updateOne']({'_id':_0x399924[_0x2dbb('0x8a')]},{'$set':_0x399924},{'upsert':!0x0})):yield _0x473d6b[_0x2dbb('0x8c')](_0x399924);}}catch(_0x281b78){throw new Error(_0x281b78[_0x2dbb('0x33')]||_0x281b78[_0x2dbb('0x2f')]||_0x281b78);}});}[_0x2dbb('0x8f')](){return u(this,void 0x0,void 0x0,function*(){let _0x28fa80=null;try{const _0xb6b312=yield this['getChangeStream']({'ChangeType':_0x2dbb('0x90')}),_0x3f16f8=yield this['getChangeStream']({'ChangeType':'StableStudy'});_0x28fa80=yield this['compareNewAndStableStudies'](_0xb6b312,_0x3f16f8);}catch(_0x2e52d0){throw Error(_0x2e52d0['msg']||_0x2e52d0);}return _0x28fa80;});}[_0x2dbb('0x91')](_0x168f52){return u(this,void 0x0,void 0x0,function*(){return yield this[_0x2dbb('0x71')][_0x2dbb('0x49')](_0x168f52);});}[_0x2dbb('0x92')](_0x1d6ccc){return u(this,void 0x0,void 0x0,function*(){const _0x278292=_0x1d6ccc[_0x2dbb('0x93')],_0x1ab771=yield this[_0x2dbb('0x91')](_0x278292);return{'studyRef':_0x1ab771['ID'],'isStable':_0x1ab771['IsStable'],'lastUpdate':_0x1ab771['LastUpdate'],'accessionNumber':_0x1ab771[_0x2dbb('0x3c')]['AccessionNumber'],'institutionName':_0x1ab771[_0x2dbb('0x3c')][_0x2dbb('0x94')],'referringPhysicianName':_0x1ab771[_0x2dbb('0x3c')][_0x2dbb('0x95')],'requestedProcedureDescription':_0x1ab771['MainDicomTags'][_0x2dbb('0x96')],'requestingPhysician':_0x1ab771['MainDicomTags'][_0x2dbb('0x97')],'studyDate':_0x1ab771['MainDicomTags']['StudyDate'],'studyDescription':_0x1ab771['MainDicomTags'][_0x2dbb('0x98')],'studyID':_0x1ab771[_0x2dbb('0x3c')][_0x2dbb('0x99')],'studyInstanceUID':_0x1ab771[_0x2dbb('0x3c')][_0x2dbb('0x3d')],'studyTime':_0x1ab771[_0x2dbb('0x3c')][_0x2dbb('0x9a')],'patientRef':_0x1ab771[_0x2dbb('0x9b')],'patientID':_0x1ab771[_0x2dbb('0x9c')][_0x2dbb('0x9d')],'patientName':_0x1ab771['PatientMainDicomTags'][_0x2dbb('0x9e')],'patientSex':_0x1ab771['PatientMainDicomTags'][_0x2dbb('0x9f')],'SeriesRefs':_0x1ab771['SeriesIds']};});}['getDataTraceByStudySerieSummary'](_0x51758a){return u(this,void 0x0,void 0x0,function*(){const _0x282ce5=_0x51758a[_0x2dbb('0x93')],_0x776b12=yield this[_0x2dbb('0x91')](_0x282ce5),_0x338e5b=[];return _0x776b12[_0x2dbb('0x4d')]['forEach'](_0x51758a=>{_0x338e5b[_0x2dbb('0x41')]({'serieRef':_0x51758a['ID'],'studyRef':_0x51758a[_0x2dbb('0xa0')],'isStable':_0x51758a[_0x2dbb('0xa1')],'lastUpdate':_0x51758a['LastUpdate'],'status':_0x51758a[_0x2dbb('0xa2')],'type':_0x51758a['Type'],'bodyPartExamined':_0x51758a[_0x2dbb('0x3c')][_0x2dbb('0xa3')],'manufacturer':_0x51758a[_0x2dbb('0x3c')][_0x2dbb('0xa4')],'modality':_0x51758a['MainDicomTags'][_0x2dbb('0xa5')],'stationName':_0x51758a[_0x2dbb('0x3c')][_0x2dbb('0xa6')],'performedProcedureStepDescription':_0x51758a[_0x2dbb('0x3c')][_0x2dbb('0xa7')],'seriesDescription':_0x51758a['MainDicomTags'][_0x2dbb('0xa8')],'seriesDate':_0x51758a[_0x2dbb('0x3c')][_0x2dbb('0xa9')],'seriesTime':_0x51758a[_0x2dbb('0x3c')]['SeriesTime'],'seriesInstanceUID':_0x51758a[_0x2dbb('0x3c')][_0x2dbb('0xaa')]});}),{'series':_0x338e5b};});}[_0x2dbb('0xab')](_0x189c00){return u(this,void 0x0,void 0x0,function*(){const _0x5b0e45=_0x189c00[_0x2dbb('0x93')],_0x2edf11=yield this[_0x2dbb('0x91')](_0x5b0e45),_0x2fe70d=[];return _0x2edf11['Series']['forEach'](_0x189c00=>{_0x2fe70d[_0x2dbb('0x41')]({'serieId':_0x189c00['ID']}),_0x189c00[_0x2dbb('0x4c')][_0x2dbb('0x40')](_0x189c00=>{_0x2fe70d[_0x2dbb('0x41')]({'instanceId':_0x189c00['ID']});});}),_0x2fe70d['push']({'studyId':_0x2edf11['ID']}),_0x2fe70d[_0x2dbb('0x41')]({'patientId':_0x2edf11['ParentPatient']}),_0x2fe70d;});}[_0x2dbb('0xac')](_0x4f9cc6){return u(this,void 0x0,void 0x0,function*(){try{if(!_0x4f9cc6)throw new Error(_0x2dbb('0xad'));const _0xbd3175=yield this[_0x2dbb('0xae')](_0x4f9cc6),_0x535c90={};for(const _0x4f9cc6 of _0xbd3175){const _0xbd3175=yield this[_0x2dbb('0x71')][_0x2dbb('0x4e')](_0x4f9cc6);_0x535c90[_0x4f9cc6]=_0xbd3175;}return _0x535c90;}catch(_0x215f77){throw new Error(_0x215f77[_0x2dbb('0x33')]||_0x215f77['message']||_0x215f77);}});}[_0x2dbb('0xae')](_0x59953e){return u(this,void 0x0,void 0x0,function*(){if(_0x59953e){const _0x51d77f=yield this['otRestSvc'][_0x2dbb('0x49')](_0x59953e);let _0x53d542=[];return _0x51d77f[_0x2dbb('0x4d')][_0x2dbb('0x40')](_0x59953e=>{_0x53d542=[..._0x59953e[_0x2dbb('0x4b')]];}),_0x53d542;}});}['getStudyInstanceUIDs'](_0x5a8120){return u(this,void 0x0,void 0x0,function*(){let _0x38f884=null;if(_0x5a8120&&_0x5a8120[_0x2dbb('0xaf')]){_0x38f884=yield this[_0x2dbb('0x71')]['getStudies']();let _0x5a8120=[];for(let _0x3478eb=0x0;_0x3478eb<_0x38f884[_0x2dbb('0x2a')];_0x3478eb++){const _0x3ddc30=_0x38f884[_0x3478eb];_0x5a8120[_0x2dbb('0x41')]({'studyUID':_0x3ddc30[_0x2dbb('0xb0')],'studyId':_0x3ddc30[_0x2dbb('0x93')],'server':this[_0x2dbb('0x71')][_0x2dbb('0x27')](),'url':this[_0x2dbb('0x71')][_0x2dbb('0x27')]()+'/studies/'+_0x3ddc30[_0x2dbb('0x93')]});}_0x38f884=_0x5a8120;}else _0x38f884=yield this[_0x2dbb('0x71')][_0x2dbb('0x3a')]();return _0x38f884;});}[_0x2dbb('0xb1')](_0x559387){return u(this,void 0x0,void 0x0,function*(){try{if(!_0x559387)throw new Error(_0x2dbb('0xad'));let _0x494b09=0x0;const _0x2a450d=yield this[_0x2dbb('0xae')](_0x559387);if(_0x2a450d&&Array[_0x2dbb('0x88')](_0x2a450d)&&_0x2a450d[_0x2dbb('0x2a')]>0x0){let _0x1fbd59=0x0;for(let _0x559387 of _0x2a450d){const _0x3c47fa=yield this[_0x2dbb('0x71')][_0x2dbb('0x30')](_0x559387);_0x3c47fa&&_0x3c47fa['FileSize']&&(_0x1fbd59+=_0x3c47fa[_0x2dbb('0xb2')]);}return _0x494b09=_0x2a450d[_0x2dbb('0x2a')],{'studyId':_0x559387,'numOfInstances':_0x494b09,'studyDiskSize':_0x1fbd59,'studyDiskSizeFormated':(_0x49d5bb=_0x1fbd59,_0x49d5bb<0x400?_0x49d5bb+_0x2dbb('0xb3'):_0x49d5bb<0x100000?(_0x49d5bb/0x400)['toFixed'](0x3)+_0x2dbb('0xb4'):_0x49d5bb<0x40000000?(_0x49d5bb/0x100000)[_0x2dbb('0xb5')](0x3)+_0x2dbb('0xb6'):(_0x49d5bb/0x40000000)['toFixed'](0x3)+_0x2dbb('0xb7')),'OrthancServerURL':this[_0x2dbb('0xb8')]()};}}catch(_0x1d6fd2){const _0x364f60=_0x1d6fd2['msg']||_0x1d6fd2[_0x2dbb('0x2f')]||_0x1d6fd2,_0x1631f5={'msg':{'studyId':_0x559387,'OrthancServerURL':this[_0x2dbb('0xb8')]()}};throw new Error(JSON[_0x2dbb('0xb9')]({'err':_0x364f60,'feedback':_0x1631f5}));}var _0x49d5bb;});}[_0x2dbb('0xba')](_0x3a0f95){return u(this,void 0x0,void 0x0,function*(){try{return yield this[_0x2dbb('0x71')][_0x2dbb('0x30')](_0x3a0f95);}catch(_0xa31483){throw new Error(_0xa31483[_0x2dbb('0x33')]||_0xa31483[_0x2dbb('0x2f')]||_0xa31483);}});}static[_0x2dbb('0x7d')](_0x5d24b8,_0x6fe57f){const _0x1f0586=m['genMongConnString'](_0x5d24b8['MongoConfig']);m[_0x2dbb('0x83')](_0x1f0586['connString']);const _0x1b715c=m['getInstance'](_0x1f0586[_0x2dbb('0x5a')]);return new f({'MongoServiceInstance':_0x1b715c,'OrthancRestClientInstance':new S({'orthancBaseURL':_0x6fe57f})});}static[_0x2dbb('0xbb')](_0xbe726b){const _0x38fb24=[];return _0xbe726b[_0x2dbb('0xbc')][_0x2dbb('0x40')](_0x302530=>{const _0x5e59f1=f[_0x2dbb('0x7d')](_0xbe726b,_0x302530);_0x38fb24[_0x2dbb('0x41')](_0x5e59f1);}),_0x38fb24;}[_0x2dbb('0xbd')](_0x3b979d,_0x480eaf){return u(this,void 0x0,void 0x0,function*(){if(!0x1===Array['isArray'](_0x3b979d)||!0x1===Array[_0x2dbb('0x88')](_0x480eaf))return[];const _0x525bc8=a[_0x2dbb('0x3b')](_0x3b979d,'ID'),_0x4fbc8a=a[_0x2dbb('0xbe')](_0x480eaf)[_0x2dbb('0x3b')]('ID')[_0x2dbb('0xbf')]()['value'](),_0x582890=[];for(let _0x3b979d=0x0;_0x3b979d<_0x525bc8['length'];_0x3b979d++){const _0x480eaf=_0x525bc8[_0x3b979d];_0x4fbc8a[_0x2dbb('0xc0')](_0x480eaf)>-0x1&&_0x582890[_0x2dbb('0x41')](_0x480eaf);}const _0x500430=[];for(let _0x480eaf=0x0;_0x480eaf<_0x582890[_0x2dbb('0x2a')];_0x480eaf++){const _0x525bc8=_0x582890[_0x480eaf],_0x4fbc8a=a['find'](_0x3b979d,{'ID':_0x525bc8});_0x4fbc8a&&_0x500430[_0x2dbb('0x41')](_0x4fbc8a);}return _0x500430;});}[_0x2dbb('0xb8')](){const _0x46d506=this[_0x2dbb('0x71')][_0x2dbb('0x27')]()[_0x2dbb('0x29')](_0x2dbb('0xc1'));let _0x374968=_0x46d506[0x0];return _0x46d506[_0x2dbb('0x2a')]>0x0&&(_0x374968=_0x46d506[0x1]),_0x374968;}}class C{constructor(){}static['convertStringToDate'](_0x4ce4c9){const _0x3b7ef6=d[_0x2dbb('0xc2')](_0x4ce4c9);return 0x1==isNaN(_0x3b7ef6[_0x2dbb('0xc3')]())?_0x4ce4c9:_0x3b7ef6;}}require(_0x2dbb('0xe'))[_0x2dbb('0xf')]();class p{constructor(_0x7c5c07){this[_0x2dbb('0xc4')]='',this['otRestSvc']=null,this['Collections']=null,_0x7c5c07&&_0x7c5c07[_0x2dbb('0x7f')]?(this[_0x2dbb('0x71')]=_0x7c5c07['OrthancRestClientInstance'],process[_0x2dbb('0x21')][_0x2dbb('0x26')]&&console[_0x2dbb('0x1a')](_0x2dbb('0x80'))):this[_0x2dbb('0x71')]=new S(),_0x7c5c07&&_0x7c5c07[_0x2dbb('0x81')]?(this['mongoDataService']=_0x7c5c07[_0x2dbb('0x81')],process['env'][_0x2dbb('0x26')]&&console['log']('Got\x20-\x20MongoServiceInstance')):this[_0x2dbb('0x72')]=m[_0x2dbb('0x30')](process[_0x2dbb('0x21')][_0x2dbb('0x82')]||'RISPACS'),this[_0x2dbb('0x7e')]=I['createInstance'](this[_0x2dbb('0x71')],this[_0x2dbb('0x72')]);}static[_0x2dbb('0x7d')](_0x26063e,_0x2493bf){const _0x54fa32=m[_0x2dbb('0x5c')](_0x26063e[_0x2dbb('0xc5')]);m[_0x2dbb('0x83')](_0x54fa32['connString']);const _0x2ea03f=m['getInstance'](_0x54fa32['dbName']);return new p({'OrthancRestClientInstance':new S({'orthancBaseURL':_0x2493bf}),'MongoServiceInstance':_0x2ea03f});}static[_0x2dbb('0xbb')](_0x230383){const _0x59999d=[];return _0x230383[_0x2dbb('0xbc')][_0x2dbb('0x40')](_0x2b6a23=>{const _0x40f9ed=p[_0x2dbb('0x7d')](_0x230383,_0x2b6a23);_0x59999d[_0x2dbb('0x41')](_0x40f9ed);}),_0x59999d;}[_0x2dbb('0xc6')](){return this[_0x2dbb('0x71')][_0x2dbb('0x27')]();}[_0x2dbb('0xc7')](_0x54d225){return u(this,void 0x0,void 0x0,function*(){if(_0x54d225['resumeIndexing']&&null===_0x54d225[_0x2dbb('0xc8')])throw new Error(_0x2dbb('0xc9'));let _0x4610e3={'since':_0x54d225['startFrom']-0x1,'limit':0x1};const _0x5930b9=yield this[_0x2dbb('0x71')]['getChanges'](_0x4610e3);for(const _0x4610e3 of _0x5930b9[_0x2dbb('0xca')]){if(_0x54d225[_0x2dbb('0xc8')]!==_0x4610e3[_0x2dbb('0xcb')])return _0x4610e3['ChangeType']='missing\x20Seq\x20at\x20Orthanc\x20changes\x20api',_0x4610e3[_0x2dbb('0xcc')]=new Date()['toISOString'](),_0x4610e3['ts']=new Date(),_0x4610e3['ID']='NA',_0x4610e3[_0x2dbb('0xcd')]='NA',_0x4610e3[_0x2dbb('0xce')]='NA',_0x4610e3[_0x2dbb('0xcb')]=_0x54d225[_0x2dbb('0xc8')],yield this['indexChangeItem'](_0x4610e3);yield this['indexChangeItem'](_0x4610e3);}});}[_0x2dbb('0xcf')](_0x403a43){return u(this,void 0x0,void 0x0,function*(){try{let _0x18c4c2=!0x0,_0x457d83=null,_0x444ea7=null,_0x35934a=null;const _0x4ec202=yield this['getLastIndexedChangeStreamSeq']();_0x35934a=null===_0x4ec202?0x0:_0x4ec202,_0x403a43&&!0x0===_0x403a43[_0x2dbb('0xd0')]&&(_0x457d83={'since':_0x4ec202}),y[_0x2dbb('0x55')](_0x2dbb('0xd1')+JSON['stringify'](_0x457d83));let _0x293f74=0x1,_0xb32db2=0x0;function _0x3069c6(_0x403a43){return new Promise(_0x3069c6=>{setTimeout(_0x3069c6,_0x403a43);});}for(;_0x18c4c2;)try{const _0x403a43=yield this[_0x2dbb('0x71')]['getChanges'](_0x457d83);for(const _0x3069c6 of _0x403a43[_0x2dbb('0xca')])yield this['indexChangeItem'](_0x3069c6),_0xb32db2++;_0x18c4c2=!this['isLast'](_0x403a43);let _0x35934a=null;_0x18c4c2&&(_0x457d83={'since':_0x35934a=_0x444ea7=this[_0x2dbb('0xd2')](_0x403a43)},process[_0x2dbb('0x21')][_0x2dbb('0xd3')]&&y[_0x2dbb('0x55')]('Next\x20Batch')),y[_0x2dbb('0xd4')]('nextSeq\x20'+_0x35934a+_0x2dbb('0xd5')+_0x293f74+_0x2dbb('0xd6')+_0xb32db2),_0x293f74++;}catch(_0x195803){if(_0x195803[_0x2dbb('0x2f')][_0x2dbb('0xc0')](_0x2dbb('0x13'))>-0x1){console['error'](_0x195803[_0x2dbb('0x2f')],_0x2dbb('0xd7')),yield _0x3069c6(0x5dc);continue;}throw new Error(_0x195803[_0x2dbb('0x33')]||_0x195803[_0x2dbb('0x2f')]||_0x195803);}let _0x16f1ac=yield this[_0x2dbb('0xd8')](_0x35934a);for(const _0x403a43 of _0x16f1ac['missingSeqs'])yield this[_0x2dbb('0xc7')]({'startFrom':_0x403a43});if((_0x16f1ac=yield this[_0x2dbb('0xd8')](_0x35934a))&&0x0===_0x16f1ac[_0x2dbb('0xd9')][_0x2dbb('0x2a')]){const _0x403a43={'initialBatchSeq':_0x35934a,'lastSeq':_0x16f1ac[_0x2dbb('0xda')]||_0x35934a,'ts':new Date()};yield this['insertDocument'](_0x403a43,yield this[_0x2dbb('0x7e')]['getIndexBatchCol']()),y['success']('Done'),y[_0x2dbb('0xd4')](_0x403a43);}yield this[_0x2dbb('0x72')][_0x2dbb('0x6d')]();}catch(_0x361263){throw new Error(_0x361263[_0x2dbb('0x33')]||_0x361263[_0x2dbb('0x2f')]||_0x361263);}});}[_0x2dbb('0xdb')](){return u(this,void 0x0,void 0x0,function*(){let _0x3bdc2b=null;const _0xb1d62e=yield this['Collections'][_0x2dbb('0x73')]();return _0x3bdc2b=yield _0xb1d62e[_0x2dbb('0x86')]()[_0x2dbb('0xdc')]({'Seq':-0x1})[_0x2dbb('0x46')](0x1)[_0x2dbb('0x85')](),Array[_0x2dbb('0x88')](_0x3bdc2b)&&(_0x3bdc2b=_0x3bdc2b[0x0]),_0x3bdc2b&&_0x3bdc2b['Seq']?_0x3bdc2b[_0x2dbb('0xcb')]:null;});}[_0x2dbb('0xdd')](){return u(this,void 0x0,void 0x0,function*(){const _0x5b11b2=this[_0x2dbb('0x72')];try{yield _0x5b11b2[_0x2dbb('0x6b')]();}catch(_0x31b321){}const _0x236a66=yield this[_0x2dbb('0x7e')]['getOrthancStreamCollection'](),_0x2a15e2=yield _0x236a66[_0x2dbb('0x86')]({'ChangeType':_0x2dbb('0xde')})['toArray']();console[_0x2dbb('0x1a')](_0x2a15e2);});}[_0x2dbb('0xdf')](_0x163332){return u(this,void 0x0,void 0x0,function*(){const _0x1b5b0f=l(_0x163332[_0x2dbb('0xe0')]+'_'+_0x163332['ID']+'_'+_0x163332[_0x2dbb('0xcc')]+'_'+_0x163332[_0x2dbb('0xcb')]);let _0x1f70b3=Object[_0x2dbb('0xe1')]({},_0x163332);yield this[_0x2dbb('0xe2')](_0x1f70b3,_0x1b5b0f);});}[_0x2dbb('0xd8')](_0x24eb40){return u(this,void 0x0,void 0x0,function*(){const _0x23f64c=yield this[_0x2dbb('0x7e')]['getOrthancStreamCollection']();let _0x5b3111=yield _0x23f64c[_0x2dbb('0x86')]({'Seq':{'$gt':_0x24eb40}})[_0x2dbb('0xe3')]({'Seq':0x1,'_id':-0x1})[_0x2dbb('0xdc')]({'Seq':0x1})[_0x2dbb('0x85')]();return{'lastSeq':(_0x5b3111=_0x5b3111[_0x2dbb('0x3b')](_0x24eb40=>_0x24eb40['Seq']))[_0x5b3111[_0x2dbb('0x2a')]-0x1],'missingSeqs':_0x5b3111[_0x2dbb('0xe4')](function(_0x24eb40,_0x23f64c,_0x5b3111,_0x3b7ff7){var _0x4e2e17=_0x23f64c-_0x3b7ff7[_0x5b3111-0x1];if(_0x4e2e17>0x1)for(var _0x12d916=0x1;_0x12d916<_0x4e2e17;)_0x24eb40[_0x2dbb('0x41')](_0x3b7ff7[_0x5b3111-0x1]+_0x12d916),_0x12d916++;return _0x24eb40;},[])};});}[_0x2dbb('0xe5')](_0x2a4d15,_0x5e4954){return u(this,void 0x0,void 0x0,function*(){for(;;)try{const _0xcd4c54=_0x5e4954;var _0x2672a3=_0xcd4c54['find']({})[_0x2dbb('0xdc')]({'_id':-0x1})['limit'](0x1);let _0x401fd6=0x1;if(yield _0x2672a3[_0x2dbb('0xe6')]()){_0x401fd6=(yield _0x2672a3[_0x2dbb('0xd')]())[_0x2dbb('0x8a')]+0x1;}yield _0xcd4c54[_0x2dbb('0x8c')](Object[_0x2dbb('0xe1')]({'_id':_0x401fd6},_0x2a4d15));break;}catch(_0x293744){if(_0x293744[_0x2dbb('0x2f')]['indexOf'](_0x2dbb('0xe7'))>-0x1)continue;throw new Error(_0x293744[_0x2dbb('0x33')]||_0x293744[_0x2dbb('0x2f')]||_0x293744);}});}[_0x2dbb('0xe2')](_0x5742c5,_0x4b1e55){return u(this,void 0x0,void 0x0,function*(){const _0x245abc=yield this[_0x2dbb('0x7e')]['getOrthancStreamCollection'](),_0x46611f=C['convertStringToDate'](_0x5742c5[_0x2dbb('0xcc')]);delete _0x5742c5['Date'];try{const _0x552f95=yield _0x245abc['insertOne'](Object[_0x2dbb('0xe1')]({'_id':_0x4b1e55,'date':_0x46611f,'ts':new Date()},_0x5742c5));process['env'][_0x2dbb('0xd3')]&&y['success'](JSON['stringify']({'msg':_0x2dbb('0xe8')+_0x5742c5['ID']+_0x2dbb('0xe9'),'insertedCount':_0x552f95['insertedCount']}));}catch(_0x1e0e5){const _0x245abc=_0x2dbb('0xe7');if(!(_0x1e0e5['message'][_0x2dbb('0xc0')](_0x245abc)>-0x1))throw new Error(_0x1e0e5);y['info'](_0x2dbb('0xea')+_0x4b1e55+_0x2dbb('0xeb'));}});}['isLast'](_0x1edf3f){return Object[_0x2dbb('0xec')](_0x1edf3f)[_0x2dbb('0xc0')]('Done')>-0x1?_0x1edf3f[_0x2dbb('0xed')]:null;}[_0x2dbb('0xd2')](_0xab96c0){let _0x4c6947=null;if(Array[_0x2dbb('0x88')](_0xab96c0['Changes'])){const _0x35a190=_0xab96c0[_0x2dbb('0xca')][_0xab96c0[_0x2dbb('0xca')][_0x2dbb('0x2a')]-0x1];_0x35a190&&(_0x4c6947=_0x35a190[_0x2dbb('0xcb')]);}return _0x4c6947;}}const D=require(_0x2dbb('0xee')),w=require('fs'),O=require('pino');var R=require('pino-multi-stream'),M=R[_0x2dbb('0xef')](),q=[{'level':'debug','stream':M},{'level':_0x2dbb('0x55'),'stream':w[_0x2dbb('0xf0')]('/tmp/debug.stream.out')},{'level':_0x2dbb('0x56'),'stream':w['createWriteStream'](_0x2dbb('0xf1'))},{'level':_0x2dbb('0xf2'),'stream':w[_0x2dbb('0xf0')](_0x2dbb('0xf3'))},{'level':_0x2dbb('0x54'),'stream':w[_0x2dbb('0xf0')](_0x2dbb('0xf4'))}];class x{constructor(){}static['getLogger'](){return R({'streams':q});}}class b{constructor(_0x5edaf7,_0x5a86f0){this[_0x2dbb('0x81')]=null,x[_0x2dbb('0xf5')]()[_0x2dbb('0x56')]('OrthancMainService\x20-\x20started'),this['OrthancServers']=_0x5edaf7,m[_0x2dbb('0x83')](_0x5a86f0[_0x2dbb('0x5d')]),this[_0x2dbb('0x81')]=m['getInstance'](_0x5a86f0[_0x2dbb('0x5a')]);}[_0x2dbb('0xf5')](){return x[_0x2dbb('0xf5')]();}[_0x2dbb('0xf6')](){return u(this,void 0x0,void 0x0,function*(){try{yield this[_0x2dbb('0xf7')](this[_0x2dbb('0xbc')]);}catch(_0x358ad2){throw new Error(_0x358ad2['msg']||_0x358ad2[_0x2dbb('0x2f')]||_0x358ad2);}});}[_0x2dbb('0xf8')](){return u(this,void 0x0,void 0x0,function*(){try{yield this[_0x2dbb('0xf6')](),this[_0x2dbb('0xf9')]=yield this['createOrthancRestClientInstances'](this['OrthancServers']),this[_0x2dbb('0xfa')]=yield this[_0x2dbb('0xfb')](this[_0x2dbb('0xf9')]);}catch(_0x3acfba){throw new Error(_0x3acfba[_0x2dbb('0x33')]||_0x3acfba[_0x2dbb('0x2f')]||_0x3acfba);}});}[_0x2dbb('0xfc')](){return u(this,void 0x0,void 0x0,function*(){try{yield this[_0x2dbb('0xf8')]();const _0x925ce3=yield this[_0x2dbb('0xfd')](this[_0x2dbb('0xf9')]);yield this[_0x2dbb('0xfe')](_0x925ce3);}catch(_0x29c59e){throw _0x29c59e;}});}[_0x2dbb('0xff')](_0x1f479e){return u(this,void 0x0,void 0x0,function*(){try{const _0x2cdbb4=[];for(let _0xba6ca=0x0;_0xba6ca<_0x1f479e[_0x2dbb('0x2a')];_0xba6ca++){const _0x3f32e6=_0x1f479e[_0xba6ca],_0x164be3=new S({'orthancBaseURL':_0x3f32e6});_0x2cdbb4[_0x2dbb('0x41')](_0x164be3);}return _0x2cdbb4;}catch(_0x5e23e1){throw new Error(_0x5e23e1[_0x2dbb('0x33')]||_0x5e23e1[_0x2dbb('0x2f')]||_0x5e23e1);}});}[_0x2dbb('0xfb')](_0x1c755f){return u(this,void 0x0,void 0x0,function*(){try{const _0x256fde=[];for(let _0x4699fe=0x0;_0x4699fe<_0x1c755f[_0x2dbb('0x2a')];_0x4699fe++){const _0x1b04e4=_0x1c755f[_0x4699fe],_0x51768f=new f({'MongoServiceInstance':this['MongoServiceInstance'],'OrthancRestClientInstance':_0x1b04e4});_0x256fde[_0x2dbb('0x41')](_0x51768f);}return _0x256fde;}catch(_0x55574d){throw new Error(_0x55574d[_0x2dbb('0x33')]||_0x55574d[_0x2dbb('0x2f')]||_0x55574d);}});}['createOrthancDataIndexService'](_0x33084a){return u(this,void 0x0,void 0x0,function*(){try{const _0x48912e=[];for(let _0x326c9d=0x0;_0x326c9d<_0x33084a['length'];_0x326c9d++){const _0x16cdd6=_0x33084a[_0x326c9d],_0xd30f36=new p({'MongoServiceInstance':this['MongoServiceInstance'],'OrthancRestClientInstance':_0x16cdd6});_0x48912e[_0x2dbb('0x41')](_0xd30f36);}return _0x48912e;}catch(_0x376fc9){throw new Error(_0x376fc9['msg']||_0x376fc9[_0x2dbb('0x2f')]||_0x376fc9);}});}[_0x2dbb('0x100')](_0x23be63){return u(this,void 0x0,void 0x0,function*(){try{let _0x23be63=[];for(let _0x3494ae=0x0;_0x3494ae<this[_0x2dbb('0xfa')][_0x2dbb('0x2a')];_0x3494ae++){const _0x234a7a=this[_0x2dbb('0xfa')][_0x3494ae],_0x39ea68=yield _0x234a7a['getStudyInstanceUIDs']({'withServerInfo':!0x0});_0x23be63=_0x23be63[_0x2dbb('0x101')](..._0x39ea68);}return _0x23be63;}catch(_0x11a3c3){throw new Error(_0x11a3c3[_0x2dbb('0x33')]||_0x11a3c3[_0x2dbb('0x2f')]||_0x11a3c3);}});}[_0x2dbb('0xfe')](_0x288354){return u(this,void 0x0,void 0x0,function*(){try{for(let _0x2682cb=0x0;_0x2682cb<_0x288354[_0x2dbb('0x2a')];_0x2682cb++){const _0x27a69b=_0x288354[_0x2682cb];yield _0x27a69b[_0x2dbb('0xcf')]({'resumeIndexing':!0x0});}}catch(_0x2d5ed0){throw new Error(_0x2d5ed0[_0x2dbb('0x33')]||_0x2d5ed0[_0x2dbb('0x2f')]||_0x2d5ed0);}});}[_0x2dbb('0xf7')](_0x11d253){return u(this,void 0x0,void 0x0,function*(){try{let _0x4da773=0x0;if(Array['isArray'](_0x11d253)){for(let _0x3bf221=0x0;_0x3bf221<_0x11d253[_0x2dbb('0x2a')];_0x3bf221++){const _0x58fd90=_0x11d253[_0x3bf221];(yield s(_0x58fd90))&&_0x4da773++;}return _0x4da773==_0x11d253['length'];}return!0x1;}catch(_0x554a45){console[_0x2dbb('0xf2')](_0x2dbb('0x102'),this[_0x2dbb('0xbc')][_0x2dbb('0x103')](','),'are\x20not\x20online'),process['exit'](0x1);}});}}class N{constructor(_0x4fb92a){this[_0x2dbb('0x71')]=null,this['Collections']=null,_0x4fb92a&&_0x4fb92a['OrthancRestClientInstance']&&(this[_0x2dbb('0x71')]=_0x4fb92a[_0x2dbb('0x7f')]),_0x4fb92a&&_0x4fb92a[_0x2dbb('0x81')]&&(this['mongoDataService']=_0x4fb92a[_0x2dbb('0x81')]),this[_0x2dbb('0x7e')]=I[_0x2dbb('0x7d')](this[_0x2dbb('0x71')],this[_0x2dbb('0x72')]);}static['createInstance'](_0x5aeb68,_0x3b6b26){const _0x2d9dbc=m[_0x2dbb('0x5c')](_0x5aeb68[_0x2dbb('0xc5')]);m[_0x2dbb('0x83')](_0x2d9dbc['connString']);const _0x4001a3=m[_0x2dbb('0x30')](_0x2d9dbc[_0x2dbb('0x5a')]);return new N({'OrthancRestClientInstance':new S({'orthancBaseURL':_0x3b6b26}),'MongoServiceInstance':_0x4001a3});}static['createInstances'](_0xa0a45d){const _0x506d5c=[];return _0xa0a45d['OrthancServers']['forEach'](_0x50f379=>{const _0x31e648=N[_0x2dbb('0x7d')](_0xa0a45d,_0x50f379);_0x506d5c[_0x2dbb('0x41')](_0x31e648);}),_0x506d5c;}[_0x2dbb('0x104')](){return u(this,void 0x0,void 0x0,function*(){try{const _0x2b2c31=yield this['Collections'][_0x2dbb('0x76')](),_0x3b651c=yield _0x2b2c31[_0x2dbb('0x86')]()[_0x2dbb('0xdc')]({'Seq':-0x1})['limit'](0x1)['toArray']();let _0x4b4b74=0x0==_0x3b651c[_0x2dbb('0x2a')]?0x0:_0x3b651c[0x0][_0x2dbb('0xcb')];const _0x305506=yield this['Collections'][_0x2dbb('0x79')](),_0x52b920=yield _0x305506[_0x2dbb('0x86')]({'lastSeq':{'$gt':_0x4b4b74}})['sort']({'_id':0x1})[_0x2dbb('0x85')]();let _0x20122e=0x0,_0x4b1352=null;_0x52b920[_0x2dbb('0x2a')]>0x0&&(_0x20122e=_0x4b4b74,_0x4b1352=_0x52b920[_0x52b920[_0x2dbb('0x2a')]-0x1]['lastSeq']);const _0x147636=yield this[_0x2dbb('0x7e')][_0x2dbb('0x73')](),_0x34234b=[];_0x34234b[_0x2dbb('0x41')]({'Seq':{'$gt':_0x20122e}}),null!==_0x4b1352&&_0x34234b['push']({'Seq':{'$lte':_0x4b1352}});const _0x34bb3e=yield _0x147636['find']({'ChangeType':_0x2dbb('0x105'),'$and':_0x34234b})['sort']({'Seq':0x1})['project']({'ID':0x1,'Seq':0x1});let _0x4bc529=null;const _0x121946=yield _0x34bb3e['count']();let _0x10a08d=0x0;for(;yield _0x34bb3e[_0x2dbb('0xe6')]();)try{let _0x3b651c=null!==_0x4bc529?_0x4bc529:yield _0x34bb3e[_0x2dbb('0xd')]();_0x4bc529=_0x3b651c;const _0x4b4b74=_0x3b651c['ID'],_0x305506=_0x3b651c[_0x2dbb('0xcb')],_0x52b920=yield this[_0x2dbb('0x71')][_0x2dbb('0x30')](_0x4b4b74,{'useCache':!0x1}),_0x20122e=yield this['otRestSvc'][_0x2dbb('0x4e')](_0x4b4b74,{'useCache':!0x1}),_0x4b1352=yield this[_0x2dbb('0x71')][_0x2dbb('0x106')](_0x4b4b74),_0x34234b={};if(_0x4b1352)for(const [_0x175b51,_0x2b2c31]of Object[_0x2dbb('0x107')](_0x4b1352)){const _0x3b651c=Object[_0x2dbb('0xe1')]({'dicomCode':_0x175b51},_0x2b2c31);_0x34234b[_0x2b2c31[_0x2dbb('0x108')]]=_0x3b651c;}const _0x4077dd=(yield _0x147636[_0x2dbb('0x86')]({'ID':_0x4b4b74})['toArray']())[0x0],_0x3b2964=Object[_0x2dbb('0xe1')]({'_id':_0x4b4b74,'ts':new Date(),'Seq':_0x305506,'dateArrived':_0x4077dd[_0x2dbb('0x109')],'dateIndexed':_0x4077dd['ts'],'md5Hash':_0x20122e,'AccessionNumber':_0x34234b[_0x2dbb('0x10a')]?_0x34234b['AccessionNumber']['Value']:_0x2dbb('0x10b'),'dicomAsJson':_0x34234b},_0x52b920);console['log'](++_0x10a08d+_0x2dbb('0x10c')+_0x121946+'\x20-\x20'+_0x3b2964['ID']),yield _0x2b2c31[_0x2dbb('0x8c')](_0x3b2964),_0x4bc529=null;}catch(_0x2d3404){function _0x26b9fd(_0x26b9fd){return new Promise(_0x2d3404=>{setTimeout(_0x2d3404,_0x26b9fd);});}if(_0x2d3404[_0x2dbb('0x2f')][_0x2dbb('0xc0')](_0x2dbb('0x13'))>-0x1){console[_0x2dbb('0xf2')](_0x2d3404[_0x2dbb('0x2f')],_0x2dbb('0xd7')),yield _0x26b9fd(0x5dc);continue;}throw new Error(_0x2d3404['msg']||_0x2d3404[_0x2dbb('0x2f')]||_0x2d3404);}console[_0x2dbb('0x1a')](_0x2dbb('0x10d'));}catch(_0x4c90e9){throw new Error(_0x4c90e9['msg']||_0x4c90e9['message']||_0x4c90e9);}});}['indexSeries'](){return u(this,void 0x0,void 0x0,function*(){try{const _0x16e727=yield this['Collections']['getSeriesCol'](),_0x307d48=yield _0x16e727['find']()[_0x2dbb('0xdc')]({'Seq':-0x1})[_0x2dbb('0x46')](0x1)[_0x2dbb('0x85')]();let _0x1cf4db=0x0==_0x307d48[_0x2dbb('0x2a')]?0x0:_0x307d48[0x0][_0x2dbb('0xcb')];const _0xd00fe1=yield this[_0x2dbb('0x7e')][_0x2dbb('0x79')](),_0x2bb63e=yield _0xd00fe1['find']({'lastSeq':{'$gt':_0x1cf4db}})[_0x2dbb('0xdc')]({'_id':0x1})[_0x2dbb('0x85')]();let _0x22e1bb=0x0,_0x38e5da=null;_0x2bb63e[_0x2dbb('0x2a')]>0x0&&(_0x22e1bb=_0x1cf4db,_0x38e5da=_0x2bb63e[_0x2bb63e[_0x2dbb('0x2a')]-0x1][_0x2dbb('0xda')]);const _0x172124=yield this[_0x2dbb('0x7e')]['getOrthancStreamCollection'](),_0x317f87=[];_0x317f87[_0x2dbb('0x41')]({'Seq':{'$gt':_0x22e1bb}}),null!==_0x38e5da&&_0x317f87[_0x2dbb('0x41')]({'Seq':{'$lte':_0x38e5da}});const _0x58ecfe=yield _0x172124[_0x2dbb('0x86')]({'ChangeType':'NewSeries','$and':_0x317f87})[_0x2dbb('0xdc')]({'Seq':0x1})[_0x2dbb('0xe3')]({'ID':0x1,'Seq':0x1});let _0x17b481=null;const _0x5935d3=yield _0x58ecfe[_0x2dbb('0x10e')]();let _0x361745=0x0;for(;yield _0x58ecfe[_0x2dbb('0xe6')]();)try{let _0x307d48=null!==_0x17b481?_0x17b481:yield _0x58ecfe[_0x2dbb('0xd')]();_0x17b481=_0x307d48;const _0x1cf4db=_0x307d48['ID'],_0xd00fe1=_0x307d48[_0x2dbb('0xcb')],_0x2bb63e=yield this[_0x2dbb('0x71')][_0x2dbb('0x36')](_0x1cf4db,{'useCache':!0x1}),_0x22e1bb=(yield _0x172124[_0x2dbb('0x86')]({'ID':_0x1cf4db})['toArray']())[0x0],_0x38e5da=Object[_0x2dbb('0xe1')]({'_id':_0x1cf4db,'ts':new Date(),'Seq':_0xd00fe1,'dateArrived':_0x22e1bb[_0x2dbb('0x109')],'dateIndexed':_0x22e1bb['ts']},_0x2bb63e);console['log'](++_0x361745+'\x20of\x20'+_0x5935d3+_0x2dbb('0x52')+_0x38e5da['ID']),yield _0x16e727[_0x2dbb('0x8c')](_0x38e5da),_0x17b481=null;}catch(_0x4935b5){function _0x4eb822(_0x4eb822){return new Promise(_0x4935b5=>{setTimeout(_0x4935b5,_0x4eb822);});}if(_0x4935b5[_0x2dbb('0x2f')][_0x2dbb('0xc0')](_0x2dbb('0x13'))>-0x1){console['error'](_0x4935b5[_0x2dbb('0x2f')],_0x2dbb('0xd7')),yield _0x4eb822(0x5dc);continue;}throw new Error(_0x4935b5[_0x2dbb('0x33')]||_0x4935b5[_0x2dbb('0x2f')]||_0x4935b5);}console[_0x2dbb('0x1a')](_0x2dbb('0x10d'));}catch(_0x4d63f5){throw new Error(_0x4d63f5[_0x2dbb('0x33')]||_0x4d63f5['message']||_0x4d63f5);}});}['indexPrometheus'](){return u(this,void 0x0,void 0x0,function*(){try{const _0x569c93=(yield this['otRestSvc'][_0x2dbb('0x10f')]())[_0x2dbb('0x29')]('\x0a'),_0x33a5ac=[];for(const _0x2f9181 of _0x569c93){const _0x569c93=_0x2f9181['split']('\x20');if(!0x1===Array[_0x2dbb('0x88')](_0x569c93)||0x0===_0x569c93[_0x2dbb('0x2a')]||''===_0x569c93[0x0])continue;const _0x1f3b35={'_id':_0x569c93[0x0],'metric':_0x569c93[0x0],'value':+_0x569c93[0x1],'ts':new Date(+_0x569c93[0x2])};_0x33a5ac[_0x2dbb('0x41')](_0x1f3b35);}const _0x10fb32=yield this[_0x2dbb('0x7e')]['getPrometheusMetricsCol']();for(const _0x569c93 of _0x33a5ac)try{yield _0x10fb32[_0x2dbb('0x8c')](_0x569c93);}catch(_0x12301c){if(0x2af8===_0x12301c['code'])continue;}console[_0x2dbb('0x1a')](_0x569c93);}catch(_0x4b29b7){throw new Error(_0x4b29b7['msg']||_0x4b29b7[_0x2dbb('0x2f')]||_0x4b29b7);}});}}class B{[_0x2dbb('0x110')](_0x1937cd,_0x2ba65){return new Promise((_0x4b46b8,_0x93d3bf)=>{h[_0x2dbb('0x111')](_0x1937cd,_0x2ba65,function(_0x1937cd){_0x1937cd&&_0x93d3bf(_0x1937cd),_0x4b46b8(!0x0);});});}}exports['ConsoleLoggingService']=y,exports[_0x2dbb('0x112')]=B,exports['InstancesIndexingService']=N,exports[_0x2dbb('0x113')]=x,exports[_0x2dbb('0x114')]=m,exports['OrthancDataIndexService']=p,exports[_0x2dbb('0x115')]=f,exports['OrthancMainService']=b,exports[_0x2dbb('0x116')]=S;
