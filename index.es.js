var _0x5ec8=['getDicomasJsonByInstanceId','/attachments/dicom-as-json/data','getOrCache\x20-\x20','\x20-\x20','success','allowLogging','fatal','debug','info','prettyjson','render','green','magenta','dbName','setMongoDBConnString','MONGO_URL','set','instance','genMongConnString','mongodb://','userName','password','host','port','replSetName','/?replSet=','mongodb://localhost:27017','isConnected','client','connect','Mongo\x20Connectado\x20com\x20Sucesso','close','collection','otRestSvc','mongoDataService','getOrthancStreamCollection','OrthancChangeStream_','getCollection','createIndex','getInstancesCol','Instances_','Series_','IndexBatch_','getPrometheusMetricsCol','PrometheusMetrics_','createInstance','OrthancRestClientInstance','Got\x20-\x20OrthancRestClientInstance','MongoServiceInstance','Got\x20-\x20MongoServiceInstance','MONGO_DB_NAME','RISPACS','Collections','getChangeStream','find','toArray','_getOrthancNodeBaseURL','getGenericCol','isArray','OrthancServerURL','_id','updateOne','insertOne','getStableNewStudies','NewStudy','StableStudy','compareNewAndStableStudies','getDataTraceByStudySummary','LastUpdate','AccessionNumber','InstitutionName','ReferringPhysicianName','RequestedProcedureDescription','StudyDate','StudyDescription','StudyID','StudyTime','ParentPatient','PatientID','PatientMainDicomTags','PatientName','PatientSex','getDataTraceByStudySerieSummary','studyId','getDataTraceByStudy','forEach','Status','BodyPartExamined','Manufacturer','Modality','StationName','PerformedProcedureStepDescription','SeriesDescription','SeriesDate','SeriesTime','SeriesInstanceUID','getDataTraceByStudyResourcesListUIDS','getStudyRelatedInstancesMd5','Parameter\x20not\x20provided','getStudyRelatedInstances','getStudyInstanceUIDs','studyUID','/studies/','getStudySize','FileSize','\x20Bytes','toFixed','\x20KB','\x20MB','\x20GB','stringify','getInstanceInfo','MongoConfig','connString','createInstances','OrthancServers','uniq','convertStringToDate','getTime','orthancRestBaseURL','getOrthancRestInstanceInfo','addMissing','resumeIndexing','missing\x20parameters','startFrom','Changes','Seq','ChangeType','missing\x20Seq\x20at\x20Orthanc\x20changes\x20api','Date','toISOString','Path','ResourceType','indexChangeItem','indexChangeStream','getLastIndexedChangeStreamSeq','Starting\x20from\x20','isLast','getNextSeq','Next\x20Batch','nextSeq\x20','\x20-\x20Documents\x20Inserted:\x20','indexOf','error','vou\x20continuar\x20em\x201500ms','validateMissingSeqs','missingSeqs','lastSeq','insertDocument','getIndexBatchCol','Done','sort','indexStableStudies','insertNewItem','project','reduce','hasNext','assign','E11000\x20duplicate\x20key\x20error\x20collection','INFO','\x20added','insertedCount','Key\x20','keys','pino-multi-stream','prettyStream','createWriteStream','/tmp/debug.stream.out','/tmp/info.stream.out','/tmp/error.stream.out','getLogger','OrthancMainService\x20-\x20started','check','isOrthancServversOnLine','OrthancRestClientInstances','createOrthancRestClientInstances','loadAndIndex','createOrthancDataIndexService','runIndexAllServers','OrthancDataServiceInstances','exit','indexInstances','NewInstance','count','getMd5byInstanceId','date','Value','missing','\x20of\x20','end','indexSeries','getSeriesCol','code','appendToFile','appendFile','throw','done','value','apply','next','dotenv-defaults','config','requestCache','options','baseURL','timeout','headers','restClientInstance','create','get','endPoint','string','useCache','log','using\x20Cache','status','data','orthancBaseURL','env','ORTHANC_BASE_URL','http://localhost','restClient','DEBUG','OrthancRestClient\x20-','getBaseURLInfo','getServerAndPort','split','http://','getInstancesIds','getOrCache','instances','tools/metrics-prometheus','msg','message','getInstance','instances/','trim','getSeriesIds','getSerie','hasOwnProperty','getStudiesIds','studies','getStudies','push','studies/','map','concat','StudyInstanceUID','MainDicomTags','onlyStudyInstanceUID','onlyStudyIds','getStudy','getChanges','since','?since=','limit','&limit=','changes','getResourcesByStudyId','SeriesIds','Series','Instances','InstancesIds','length','/attachments/dicom/md5'];(function(_0xf36dd2,_0x5ea940){var _0x4d7399=function(_0x56df1f){while(--_0x56df1f){_0xf36dd2['push'](_0xf36dd2['shift']());}};_0x4d7399(++_0x5ea940);}(_0x5ec8,0xc3));var _0x263e=function(_0x3a4114,_0x375ed2){_0x3a4114=_0x3a4114-0x0;var _0x92be40=_0x5ec8[_0x3a4114];return _0x92be40;};import _0x2c9ed2 from'axios';import _0x34ae62 from'node-cache';import _0x3ec0c0 from'is-reachable';import _0x2e0d1b from'signale';import _0x137f1e from'prettyjson';import{MongoClient as _0x525873}from'mongodb';import _0x31f1af,{isObject as _0x528797}from'lodash';import{parse as _0x3f543a}from'date-fns';import _0x23e59a from'md5';import _0x14312d from'fs';function h(_0x2c9ed2,_0x34ae62,_0x3ec0c0,_0x2e0d1b){return new(_0x3ec0c0||(_0x3ec0c0=Promise))(function(_0x137f1e,_0x525873){function _0x31f1af(_0x2c9ed2){try{_0x3f543a(_0x2e0d1b['next'](_0x2c9ed2));}catch(_0x32a9bc){_0x525873(_0x32a9bc);}}function _0x528797(_0x2c9ed2){try{_0x3f543a(_0x2e0d1b[_0x263e('0x0')](_0x2c9ed2));}catch(_0x2d15e3){_0x525873(_0x2d15e3);}}function _0x3f543a(_0x2c9ed2){_0x2c9ed2[_0x263e('0x1')]?_0x137f1e(_0x2c9ed2[_0x263e('0x2')]):new _0x3ec0c0(function(_0x34ae62){_0x34ae62(_0x2c9ed2[_0x263e('0x2')]);})['then'](_0x31f1af,_0x528797);}_0x3f543a((_0x2e0d1b=_0x2e0d1b[_0x263e('0x3')](_0x2c9ed2,_0x34ae62||[]))[_0x263e('0x4')]());});}require(_0x263e('0x5'))[_0x263e('0x6')]();class u{constructor(_0x3ec0c0){this[_0x263e('0x7')]=null,this[_0x263e('0x8')]=null,this['requestCache']=new _0x34ae62({'stdTTL':0x1f4,'checkperiod':0x208});const _0x2e0d1b={};_0x3ec0c0[_0x263e('0x9')]&&(_0x2e0d1b['baseURL']=_0x3ec0c0[_0x263e('0x9')]),_0x3ec0c0['timeout']&&(_0x2e0d1b[_0x263e('0xa')]=_0x3ec0c0['timeout']),_0x3ec0c0[_0x263e('0xb')]&&(_0x2e0d1b[_0x263e('0xb')]=_0x3ec0c0[_0x263e('0xb')]),this[_0x263e('0xc')]=_0x2c9ed2[_0x263e('0xd')](_0x2e0d1b),this[_0x263e('0x8')]=_0x2e0d1b;}[_0x263e('0x6')](){return this[_0x263e('0x8')];}[_0x263e('0xe')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){const _0x34ae62=_0x2c9ed2[_0x263e('0xf')]||_0x2c9ed2;try{if(_0x263e('0x10')!=typeof _0x2c9ed2&&_0x2c9ed2[_0x263e('0x8')][_0x263e('0x11')]){console[_0x263e('0x12')](_0x263e('0x13'));const _0x2c9ed2=this[_0x263e('0x7')]['get'](_0x34ae62);if(_0x2c9ed2)return _0x2c9ed2;}const _0x3ec0c0=yield this[_0x263e('0xc')][_0x263e('0xe')](_0x34ae62);return _0x263e('0x10')!=typeof _0x2c9ed2&&!0x0===_0x2c9ed2[_0x263e('0x8')][_0x263e('0x11')]&&this[_0x263e('0x7')]['set'](_0x34ae62,{'status':_0x3ec0c0[_0x263e('0x14')],'statusText':_0x3ec0c0['statusText'],'data':_0x3ec0c0[_0x263e('0x15')]}),_0x3ec0c0;}catch(_0x41896a){throw new Error(_0x41896a);}});}}class g{constructor(_0x2c9ed2){this[_0x263e('0x16')]='';const _0x34ae62={'baseURL':(_0x2c9ed2&&_0x2c9ed2[_0x263e('0x16')]?_0x2c9ed2['orthancBaseURL']:void 0x0)||process[_0x263e('0x17')][_0x263e('0x18')]||_0x263e('0x19'),'timeout':0xfa0,'headers':{'X-Custom-Header':'foobar'}};this[_0x263e('0x1a')]=new u(_0x34ae62),this[_0x263e('0x16')]=_0x34ae62[_0x263e('0x9')],process[_0x263e('0x17')][_0x263e('0x1b')]&&console[_0x263e('0x12')](_0x263e('0x1c'),_0x34ae62[_0x263e('0x9')]);}[_0x263e('0x1d')](){return this[_0x263e('0x16')];}[_0x263e('0x1e')](){const _0x2c9ed2=this[_0x263e('0x1d')]()[_0x263e('0x1f')](_0x263e('0x20'));let _0x34ae62=_0x2c9ed2[0x0];return _0x2c9ed2['length']>0x0&&(_0x34ae62=_0x2c9ed2[0x1]),_0x34ae62;}[_0x263e('0x21')](){return h(this,void 0x0,void 0x0,function*(){let _0x2c9ed2=null;try{return(_0x2c9ed2=yield this[_0x263e('0x22')](_0x263e('0x23')))[_0x263e('0x15')];}catch(_0x58986c){throw _0x58986c;}});}['getPrometheusMetrics'](){return h(this,void 0x0,void 0x0,function*(){try{return(yield this['getOrCache'](_0x263e('0x24')))['data'];}catch(_0x14b742){throw new Error(_0x14b742[_0x263e('0x25')]||_0x14b742[_0x263e('0x26')]||_0x14b742);}});}[_0x263e('0x27')](_0x2c9ed2,_0x34ae62){return h(this,void 0x0,void 0x0,function*(){const _0x3ec0c0=!_0x34ae62||!_0x34ae62['hasOwnProperty']('useCache')||_0x34ae62['useCache'];try{return(yield this['getOrCache'](_0x263e('0x28')+_0x2c9ed2[_0x263e('0x29')](),_0x3ec0c0))['data'];}catch(_0x1a1c99){throw new Error(_0x1a1c99[_0x263e('0x25')]||_0x1a1c99[_0x263e('0x26')]||_0x1a1c99);}});}[_0x263e('0x2a')](){return h(this,void 0x0,void 0x0,function*(){try{return(yield this['getOrCache']('series'))[_0x263e('0x15')];}catch(_0x4a9732){throw _0x4a9732;}});}[_0x263e('0x2b')](_0x2c9ed2,_0x34ae62){return h(this,void 0x0,void 0x0,function*(){const _0x3ec0c0=!_0x34ae62||!_0x34ae62[_0x263e('0x2c')](_0x263e('0x11'))||_0x34ae62[_0x263e('0x11')];try{return(yield this['getOrCache']('series/'+_0x2c9ed2[_0x263e('0x29')](),_0x3ec0c0))[_0x263e('0x15')];}catch(_0x1ae616){throw _0x1ae616;}});}[_0x263e('0x2d')](){return h(this,void 0x0,void 0x0,function*(){try{return(yield this['getOrCache'](_0x263e('0x2e')))[_0x263e('0x15')];}catch(_0x213864){throw _0x213864;}});}[_0x263e('0x2f')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{const _0x34ae62=yield this[_0x263e('0x2d')](),_0x3ec0c0=[];for(const _0x2c9ed2 of _0x34ae62)_0x3ec0c0[_0x263e('0x30')](yield this[_0x263e('0x22')](_0x263e('0x31')+_0x2c9ed2));const _0x2e0d1b=_0x3ec0c0[_0x263e('0x32')](_0x2c9ed2=>void 0x0!==_0x2c9ed2&&_0x2c9ed2[_0x263e('0x15')]?_0x2c9ed2['data']:[]),_0x137f1e=[][_0x263e('0x33')](..._0x2e0d1b)['map'](_0x2c9ed2=>!!_0x2c9ed2['MainDicomTags'][_0x263e('0x34')]&&_0x2c9ed2[_0x263e('0x35')][_0x263e('0x34')]);if(_0x2c9ed2&&_0x2c9ed2[_0x263e('0x36')])return _0x137f1e;if(_0x2c9ed2&&_0x2c9ed2[_0x263e('0x37')])return _0x34ae62;{let _0x2c9ed2=[];return _0x137f1e['forEach']((_0x3ec0c0,_0x2e0d1b)=>{_0x2c9ed2['push']({'studyId':_0x34ae62[_0x2e0d1b],'studyUID':_0x3ec0c0});}),_0x2c9ed2;}}catch(_0x491fc5){throw _0x491fc5;}});}[_0x263e('0x38')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{return(yield this[_0x263e('0x22')](_0x263e('0x31')+_0x2c9ed2['trim']()))['data'];}catch(_0x270047){throw _0x270047;}});}[_0x263e('0x39')](_0x2c9ed2=null){return h(this,void 0x0,void 0x0,function*(){try{let _0x34ae62='';_0x2c9ed2&&null!==_0x2c9ed2[_0x263e('0x3a')]&&(_0x34ae62=_0x263e('0x3b')+_0x2c9ed2[_0x263e('0x3a')]),_0x2c9ed2&&_0x2c9ed2[_0x263e('0x3c')]&&null!==_0x2c9ed2[_0x263e('0x3c')]&&(_0x34ae62=_0x34ae62+_0x263e('0x3d')+_0x2c9ed2[_0x263e('0x3c')]);let _0x3ec0c0=yield this[_0x263e('0x22')](_0x263e('0x3e')+_0x34ae62,!0x1);return _0x3ec0c0=_0x3ec0c0[_0x263e('0x15')];}catch(_0x1ded4d){throw _0x1ded4d;}});}[_0x263e('0x3f')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){if(_0x2c9ed2)try{const _0x34ae62=(yield this[_0x263e('0x22')](_0x263e('0x31')+_0x2c9ed2))['data'];_0x34ae62[_0x263e('0x40')]=_0x34ae62[_0x263e('0x41')],_0x34ae62['Series']=[];for(let _0x2c9ed2=0x0;_0x2c9ed2<_0x34ae62[_0x263e('0x40')]['length'];_0x2c9ed2++){const _0x3ec0c0=_0x34ae62[_0x263e('0x40')][_0x2c9ed2],_0x2e0d1b=yield this[_0x263e('0x2b')](_0x3ec0c0);if(_0x2e0d1b){_0x2e0d1b['InstancesIds']=_0x2e0d1b[_0x263e('0x42')],_0x2e0d1b[_0x263e('0x42')]=[];const _0x2c9ed2=_0x2e0d1b[_0x263e('0x43')][_0x263e('0x44')];for(let _0x34ae62=0x0;_0x34ae62<_0x2c9ed2;_0x34ae62++){const _0x2c9ed2=_0x2e0d1b[_0x263e('0x43')][_0x34ae62],_0x3ec0c0=yield this['getInstance'](_0x2c9ed2);_0x2e0d1b[_0x263e('0x42')][_0x263e('0x30')](_0x3ec0c0);}_0x34ae62['Series'][_0x263e('0x30')](_0x2e0d1b);}}return _0x34ae62;}catch(_0x4f4dc1){throw new Error(_0x4f4dc1[_0x263e('0x25')]||_0x4f4dc1['message']||_0x4f4dc1);}});}['getMd5byInstanceId'](_0x2c9ed2,_0x34ae62){return h(this,void 0x0,void 0x0,function*(){const _0x3ec0c0=!_0x34ae62||!_0x34ae62[_0x263e('0x2c')](_0x263e('0x11'))||_0x34ae62['useCache'];try{const _0x34ae62=yield this['getOrCache'](_0x263e('0x28')+_0x2c9ed2+_0x263e('0x45'),_0x3ec0c0);return _0x34ae62[_0x263e('0x15')]||_0x34ae62;}catch(_0xa677ec){throw new Error(_0xa677ec[_0x263e('0x25')]||_0xa677ec[_0x263e('0x26')]||_0xa677ec);}});}[_0x263e('0x46')](_0x2c9ed2,_0x34ae62){return h(this,void 0x0,void 0x0,function*(){const _0x3ec0c0=!_0x34ae62||!_0x34ae62[_0x263e('0x2c')](_0x263e('0x11'))||_0x34ae62[_0x263e('0x11')];try{const _0x34ae62=yield this[_0x263e('0x22')](_0x263e('0x28')+_0x2c9ed2+_0x263e('0x47'),_0x3ec0c0);return _0x34ae62[_0x263e('0x15')]||_0x34ae62;}catch(_0x32aa85){throw new Error(_0x32aa85[_0x263e('0x25')]||_0x32aa85[_0x263e('0x26')]||_0x32aa85);}});}[_0x263e('0x22')](_0x2c9ed2,_0x34ae62=!0x0){return h(this,void 0x0,void 0x0,function*(){try{return yield this[_0x263e('0x1a')]['get']({'endPoint':_0x2c9ed2,'options':{'useCache':_0x34ae62}});}catch(_0x153147){throw _0x153147[_0x263e('0x26')]=_0x263e('0x48')+_0x2c9ed2+_0x263e('0x49')+_0x153147[_0x263e('0x26')],new Error(_0x153147);}});}}class m{constructor(){}static[_0x263e('0x4a')](_0x2c9ed2){m[_0x263e('0x4b')]&&_0x2e0d1b['success'](_0x2c9ed2);}static[_0x263e('0x4c')](_0x2c9ed2){m['allowLogging']&&_0x2e0d1b[_0x263e('0x4c')](_0x2c9ed2);}static[_0x263e('0x4d')](_0x2c9ed2){m[_0x263e('0x4b')]&&_0x2e0d1b['debug'](_0x2c9ed2);}static[_0x263e('0x4e')](_0x2c9ed2){m[_0x263e('0x4b')]&&_0x2e0d1b[_0x263e('0x4e')](_0x2c9ed2);}static[_0x263e('0x4f')](_0x2c9ed2){console[_0x263e('0x12')](_0x137f1e[_0x263e('0x50')](_0x2c9ed2,{'keysColor':_0x263e('0x51'),'dashColor':_0x263e('0x52'),'stringColor':'yellow'}));}}m[_0x263e('0x4b')]=!0x0;class S{constructor(_0x2c9ed2){this['db']=null,this[_0x263e('0x53')]='',this['client']=null,this[_0x263e('0x53')]=_0x2c9ed2;}static[_0x263e('0x54')](_0x2c9ed2){process[_0x263e('0x17')][_0x263e('0x55')]=_0x2c9ed2;}static['getInstance'](_0x2c9ed2){return S['instance']['get'](_0x2c9ed2)||S['instance'][_0x263e('0x56')](_0x2c9ed2,new S(_0x2c9ed2)),S[_0x263e('0x57')][_0x263e('0xe')](_0x2c9ed2);}static[_0x263e('0x58')](_0x2c9ed2){_0x2c9ed2['connString']&&(_0x2c9ed2=_0x2c9ed2['connString']);let _0x34ae62=_0x263e('0x59')+_0x2c9ed2[_0x263e('0x5a')]+':'+_0x2c9ed2[_0x263e('0x5b')]+'@'+_0x2c9ed2[_0x263e('0x5c')]+':'+_0x2c9ed2[_0x263e('0x5d')]+'/'+_0x2c9ed2[_0x263e('0x53')]+'?replSet='+_0x2c9ed2[_0x263e('0x5e')];return _0x2c9ed2['dontUserDBForAuth']&&(_0x34ae62=_0x263e('0x59')+_0x2c9ed2[_0x263e('0x5a')]+':'+_0x2c9ed2['password']+'@'+_0x2c9ed2[_0x263e('0x5c')]+':'+_0x2c9ed2[_0x263e('0x5d')]+_0x263e('0x5f')+_0x2c9ed2[_0x263e('0x5e')]),{'connString':_0x34ae62,'dbName':_0x2c9ed2['dbName']};}['connect'](){return h(this,void 0x0,void 0x0,function*(){try{const _0x2c9ed2=process[_0x263e('0x17')]['MONGO_URL']||_0x263e('0x60');this['client']=new _0x525873(_0x2c9ed2,{'useNewUrlParser':!0x0}),!0x1===this[_0x263e('0x61')]()&&(yield this[_0x263e('0x62')][_0x263e('0x63')](),this['db']=this[_0x263e('0x62')]['db'](this['dbName']),process[_0x263e('0x17')]['INFO']&&m[_0x263e('0x4e')](_0x263e('0x64')));}catch(_0x54faf9){throw new Error('MongoDb\x20nao\x20acessivel');}});}[_0x263e('0x61')](){return!!this['client']&&this['client'][_0x263e('0x61')]();}[_0x263e('0x65')](){return h(this,void 0x0,void 0x0,function*(){return yield this[_0x263e('0x62')][_0x263e('0x65')]();});}['getCollection'](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{return 0x0==this[_0x263e('0x61')]()&&(yield this['connect']()),this['db'][_0x263e('0x66')](_0x2c9ed2);}catch(_0x227dea){throw new Error('getCollection\x20Isso');}});}}S[_0x263e('0x57')]=new Map();class y{constructor(_0x2c9ed2,_0x34ae62){this[_0x263e('0x67')]=_0x2c9ed2,this[_0x263e('0x68')]=_0x34ae62;}[_0x263e('0x69')](){return h(this,void 0x0,void 0x0,function*(){const _0x2c9ed2=_0x263e('0x6a')+this[_0x263e('0x67')][_0x263e('0x1e')](),_0x34ae62=yield this[_0x263e('0x68')][_0x263e('0x6b')](_0x2c9ed2);return _0x34ae62[_0x263e('0x6c')]({'Seq':-0x1}),_0x34ae62[_0x263e('0x6c')]({'ID':0x1}),_0x34ae62;});}[_0x263e('0x6d')](){return h(this,void 0x0,void 0x0,function*(){const _0x2c9ed2=_0x263e('0x6e')+this[_0x263e('0x67')][_0x263e('0x1e')](),_0x34ae62=yield this[_0x263e('0x68')][_0x263e('0x6b')](_0x2c9ed2);return _0x34ae62[_0x263e('0x6c')]({'Seq':-0x1}),_0x34ae62[_0x263e('0x6c')]({'AccessionNumber':0x1}),_0x34ae62;});}['getSeriesCol'](){return h(this,void 0x0,void 0x0,function*(){const _0x2c9ed2=_0x263e('0x6f')+this[_0x263e('0x67')][_0x263e('0x1e')](),_0x34ae62=yield this[_0x263e('0x68')][_0x263e('0x6b')](_0x2c9ed2);return _0x34ae62['createIndex']({'Seq':-0x1}),_0x34ae62;});}['getIndexBatchCol'](){return h(this,void 0x0,void 0x0,function*(){const _0x2c9ed2=_0x263e('0x70')+this[_0x263e('0x67')][_0x263e('0x1e')]();return yield this['mongoDataService'][_0x263e('0x6b')](_0x2c9ed2);});}[_0x263e('0x71')](){return h(this,void 0x0,void 0x0,function*(){const _0x2c9ed2=_0x263e('0x72')+this[_0x263e('0x67')][_0x263e('0x1e')]();return yield this[_0x263e('0x68')][_0x263e('0x6b')](_0x2c9ed2);});}['getGenericCol'](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){const _0x34ae62=_0x2c9ed2+'_'+this[_0x263e('0x67')][_0x263e('0x1e')]();return yield this[_0x263e('0x68')][_0x263e('0x6b')](_0x34ae62);});}}class v{static[_0x263e('0x73')](_0x2c9ed2,_0x34ae62){return new y(_0x2c9ed2,_0x34ae62);}}class f{constructor(_0x2c9ed2){this['mongoDataService']=null,this['Collections']=null,_0x2c9ed2&&_0x2c9ed2[_0x263e('0x74')]?(_0x2c9ed2[_0x263e('0x74')][_0x263e('0x16')]?this[_0x263e('0x67')]=new g({'orthancBaseURL':_0x2c9ed2[_0x263e('0x74')]['orthancBaseURL']}):this[_0x263e('0x67')]=_0x2c9ed2[_0x263e('0x74')],process['env'][_0x263e('0x1b')]&&console[_0x263e('0x12')](_0x263e('0x75'))):this[_0x263e('0x67')]=new g(),_0x2c9ed2&&_0x2c9ed2[_0x263e('0x76')]?(this[_0x263e('0x68')]=_0x2c9ed2[_0x263e('0x76')],process[_0x263e('0x17')][_0x263e('0x1b')]&&console[_0x263e('0x12')](_0x263e('0x77'))):this['mongoDataService']=S['getInstance'](process[_0x263e('0x17')][_0x263e('0x78')]||_0x263e('0x79')),this[_0x263e('0x7a')]=v[_0x263e('0x73')](this[_0x263e('0x67')],this[_0x263e('0x68')]);}[_0x263e('0x54')](_0x2c9ed2){process[_0x263e('0x17')][_0x263e('0x55')]=_0x2c9ed2;}[_0x263e('0x7b')](_0x2c9ed2=null){return h(this,void 0x0,void 0x0,function*(){const _0x34ae62=yield this[_0x263e('0x7a')]['getOrthancStreamCollection']();return null===_0x2c9ed2?yield _0x34ae62[_0x263e('0x7c')]()['toArray']():yield _0x34ae62[_0x263e('0x7c')](_0x2c9ed2)[_0x263e('0x7d')]();});}['saveDataToDB'](_0x2c9ed2,_0x34ae62,_0x3ec0c0){return h(this,void 0x0,void 0x0,function*(){try{let _0x2e0d1b=this[_0x263e('0x7e')]();const _0x137f1e=yield this[_0x263e('0x7a')][_0x263e('0x7f')](_0x2c9ed2);if(Array[_0x263e('0x80')](_0x34ae62)&&_0x34ae62[_0x263e('0x44')]>0x0){_0x34ae62=_0x34ae62['map'](_0x2c9ed2=>(_0x2c9ed2[_0x263e('0x81')]=_0x2e0d1b,_0x2c9ed2['ts']=new Date(),_0x2c9ed2)),_0x3ec0c0&&(_0x34ae62=_0x34ae62[_0x263e('0x32')](_0x2c9ed2=>_0x2c9ed2[_0x263e('0x82')]=_0x2c9ed2[_0x3ec0c0]));for(const _0x2c9ed2 of _0x34ae62)_0x3ec0c0?(_0x2c9ed2[_0x263e('0x82')]=_0x2c9ed2[_0x3ec0c0],yield _0x137f1e[_0x263e('0x83')]({'_id':_0x2c9ed2[_0x263e('0x82')]},{'$set':_0x2c9ed2},{'upsert':!0x0})):yield _0x137f1e['insertOne'](_0x2c9ed2);}else{if(!_0x528797(_0x34ae62))throw new Error('Data\x20provided\x20is\x20not\x20an\x20Object\x20not\x20an\x20Array');_0x34ae62['ts']=new Date(),_0x34ae62['OrthancServerURL']=_0x2e0d1b,_0x3ec0c0?(_0x34ae62[_0x263e('0x82')]=_0x34ae62[_0x3ec0c0],yield _0x137f1e[_0x263e('0x83')]({'_id':_0x34ae62[_0x263e('0x82')]},{'$set':_0x34ae62},{'upsert':!0x0})):yield _0x137f1e[_0x263e('0x84')](_0x34ae62);}}catch(_0x68945e){throw new Error(_0x68945e[_0x263e('0x25')]||_0x68945e[_0x263e('0x26')]||_0x68945e);}});}[_0x263e('0x85')](){return h(this,void 0x0,void 0x0,function*(){let _0x2c9ed2=null;try{const _0x34ae62=yield this[_0x263e('0x7b')]({'ChangeType':_0x263e('0x86')}),_0x3ec0c0=yield this[_0x263e('0x7b')]({'ChangeType':_0x263e('0x87')});_0x2c9ed2=yield this[_0x263e('0x88')](_0x34ae62,_0x3ec0c0);}catch(_0x3d47d1){throw Error(_0x3d47d1[_0x263e('0x25')]||_0x3d47d1);}return _0x2c9ed2;});}['getDataTraceByStudy'](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){return yield this[_0x263e('0x67')][_0x263e('0x3f')](_0x2c9ed2);});}[_0x263e('0x89')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){const _0x34ae62=_0x2c9ed2['studyId'],_0x3ec0c0=yield this['getDataTraceByStudy'](_0x34ae62);return{'studyRef':_0x3ec0c0['ID'],'isStable':_0x3ec0c0['IsStable'],'lastUpdate':_0x3ec0c0[_0x263e('0x8a')],'accessionNumber':_0x3ec0c0[_0x263e('0x35')][_0x263e('0x8b')],'institutionName':_0x3ec0c0[_0x263e('0x35')][_0x263e('0x8c')],'referringPhysicianName':_0x3ec0c0[_0x263e('0x35')][_0x263e('0x8d')],'requestedProcedureDescription':_0x3ec0c0['MainDicomTags'][_0x263e('0x8e')],'requestingPhysician':_0x3ec0c0[_0x263e('0x35')]['RequestingPhysician'],'studyDate':_0x3ec0c0[_0x263e('0x35')][_0x263e('0x8f')],'studyDescription':_0x3ec0c0[_0x263e('0x35')][_0x263e('0x90')],'studyID':_0x3ec0c0[_0x263e('0x35')][_0x263e('0x91')],'studyInstanceUID':_0x3ec0c0[_0x263e('0x35')]['StudyInstanceUID'],'studyTime':_0x3ec0c0[_0x263e('0x35')][_0x263e('0x92')],'patientRef':_0x3ec0c0[_0x263e('0x93')],'patientID':_0x3ec0c0['PatientMainDicomTags'][_0x263e('0x94')],'patientName':_0x3ec0c0[_0x263e('0x95')][_0x263e('0x96')],'patientSex':_0x3ec0c0[_0x263e('0x95')][_0x263e('0x97')],'SeriesRefs':_0x3ec0c0[_0x263e('0x40')]};});}[_0x263e('0x98')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){const _0x34ae62=_0x2c9ed2[_0x263e('0x99')],_0x3ec0c0=yield this[_0x263e('0x9a')](_0x34ae62),_0x2e0d1b=[];return _0x3ec0c0[_0x263e('0x41')][_0x263e('0x9b')](_0x2c9ed2=>{_0x2e0d1b[_0x263e('0x30')]({'serieRef':_0x2c9ed2['ID'],'studyRef':_0x2c9ed2['ParentStudy'],'isStable':_0x2c9ed2['IsStable'],'lastUpdate':_0x2c9ed2['LastUpdate'],'status':_0x2c9ed2[_0x263e('0x9c')],'type':_0x2c9ed2['Type'],'bodyPartExamined':_0x2c9ed2[_0x263e('0x35')][_0x263e('0x9d')],'manufacturer':_0x2c9ed2[_0x263e('0x35')][_0x263e('0x9e')],'modality':_0x2c9ed2[_0x263e('0x35')][_0x263e('0x9f')],'stationName':_0x2c9ed2[_0x263e('0x35')][_0x263e('0xa0')],'performedProcedureStepDescription':_0x2c9ed2[_0x263e('0x35')][_0x263e('0xa1')],'seriesDescription':_0x2c9ed2[_0x263e('0x35')][_0x263e('0xa2')],'seriesDate':_0x2c9ed2[_0x263e('0x35')][_0x263e('0xa3')],'seriesTime':_0x2c9ed2['MainDicomTags'][_0x263e('0xa4')],'seriesInstanceUID':_0x2c9ed2['MainDicomTags'][_0x263e('0xa5')]});}),{'series':_0x2e0d1b};});}[_0x263e('0xa6')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){const _0x34ae62=_0x2c9ed2[_0x263e('0x99')],_0x3ec0c0=yield this[_0x263e('0x9a')](_0x34ae62),_0x2e0d1b=[];return _0x3ec0c0[_0x263e('0x41')][_0x263e('0x9b')](_0x2c9ed2=>{_0x2e0d1b[_0x263e('0x30')]({'serieId':_0x2c9ed2['ID']}),_0x2c9ed2[_0x263e('0x42')][_0x263e('0x9b')](_0x2c9ed2=>{_0x2e0d1b[_0x263e('0x30')]({'instanceId':_0x2c9ed2['ID']});});}),_0x2e0d1b['push']({'studyId':_0x3ec0c0['ID']}),_0x2e0d1b['push']({'patientId':_0x3ec0c0['ParentPatient']}),_0x2e0d1b;});}[_0x263e('0xa7')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{if(!_0x2c9ed2)throw new Error(_0x263e('0xa8'));const _0x34ae62=yield this['getStudyRelatedInstances'](_0x2c9ed2),_0x3ec0c0={};for(const _0x2c9ed2 of _0x34ae62){const _0x34ae62=yield this[_0x263e('0x67')]['getMd5byInstanceId'](_0x2c9ed2);_0x3ec0c0[_0x2c9ed2]=_0x34ae62;}return _0x3ec0c0;}catch(_0x2c14b5){throw new Error(_0x2c14b5[_0x263e('0x25')]||_0x2c14b5['message']||_0x2c14b5);}});}[_0x263e('0xa9')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){if(_0x2c9ed2){const _0x34ae62=yield this[_0x263e('0x67')][_0x263e('0x3f')](_0x2c9ed2);let _0x3ec0c0=[];return _0x34ae62[_0x263e('0x41')][_0x263e('0x9b')](_0x2c9ed2=>{_0x3ec0c0=[..._0x2c9ed2[_0x263e('0x43')]];}),_0x3ec0c0;}});}[_0x263e('0xaa')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){let _0x34ae62=null;if(_0x2c9ed2&&_0x2c9ed2['withServerInfo']){_0x34ae62=yield this[_0x263e('0x67')][_0x263e('0x2f')]();let _0x2c9ed2=[];for(let _0x3ec0c0=0x0;_0x3ec0c0<_0x34ae62['length'];_0x3ec0c0++){const _0x2e0d1b=_0x34ae62[_0x3ec0c0];_0x2c9ed2[_0x263e('0x30')]({'studyUID':_0x2e0d1b[_0x263e('0xab')],'studyId':_0x2e0d1b[_0x263e('0x99')],'server':this[_0x263e('0x67')]['getBaseURLInfo'](),'url':this[_0x263e('0x67')][_0x263e('0x1d')]()+_0x263e('0xac')+_0x2e0d1b[_0x263e('0x99')]});}_0x34ae62=_0x2c9ed2;}else _0x34ae62=yield this['otRestSvc'][_0x263e('0x2f')]();return _0x34ae62;});}[_0x263e('0xad')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{if(!_0x2c9ed2)throw new Error(_0x263e('0xa8'));let _0x3ec0c0=0x0;const _0x2e0d1b=yield this[_0x263e('0xa9')](_0x2c9ed2);if(_0x2e0d1b&&Array[_0x263e('0x80')](_0x2e0d1b)&&_0x2e0d1b[_0x263e('0x44')]>0x0){let _0x137f1e=0x0;for(let _0x2c9ed2 of _0x2e0d1b){const _0x34ae62=yield this[_0x263e('0x67')][_0x263e('0x27')](_0x2c9ed2);_0x34ae62&&_0x34ae62[_0x263e('0xae')]&&(_0x137f1e+=_0x34ae62[_0x263e('0xae')]);}return _0x3ec0c0=_0x2e0d1b[_0x263e('0x44')],{'studyId':_0x2c9ed2,'numOfInstances':_0x3ec0c0,'studyDiskSize':_0x137f1e,'studyDiskSizeFormated':(_0x34ae62=_0x137f1e,_0x34ae62<0x400?_0x34ae62+_0x263e('0xaf'):_0x34ae62<0x100000?(_0x34ae62/0x400)[_0x263e('0xb0')](0x3)+_0x263e('0xb1'):_0x34ae62<0x40000000?(_0x34ae62/0x100000)[_0x263e('0xb0')](0x3)+_0x263e('0xb2'):(_0x34ae62/0x40000000)[_0x263e('0xb0')](0x3)+_0x263e('0xb3')),'OrthancServerURL':this[_0x263e('0x7e')]()};}}catch(_0x883a4c){const _0x3ec0c0=_0x883a4c['msg']||_0x883a4c[_0x263e('0x26')]||_0x883a4c,_0x2e0d1b={'msg':{'studyId':_0x2c9ed2,'OrthancServerURL':this['_getOrthancNodeBaseURL']()}};throw new Error(JSON[_0x263e('0xb4')]({'err':_0x3ec0c0,'feedback':_0x2e0d1b}));}var _0x34ae62;});}[_0x263e('0xb5')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{return yield this['otRestSvc'][_0x263e('0x27')](_0x2c9ed2);}catch(_0x4b4588){throw new Error(_0x4b4588[_0x263e('0x25')]||_0x4b4588['message']||_0x4b4588);}});}static[_0x263e('0x73')](_0x2c9ed2,_0x34ae62){const _0x3ec0c0=S[_0x263e('0x58')](_0x2c9ed2[_0x263e('0xb6')]);S['setMongoDBConnString'](_0x3ec0c0[_0x263e('0xb7')]);const _0x2e0d1b=S['getInstance'](_0x3ec0c0[_0x263e('0x53')]);return new f({'MongoServiceInstance':_0x2e0d1b,'OrthancRestClientInstance':new g({'orthancBaseURL':_0x34ae62})});}static[_0x263e('0xb8')](_0x2c9ed2){const _0x34ae62=[];return _0x2c9ed2[_0x263e('0xb9')][_0x263e('0x9b')](_0x3ec0c0=>{const _0x2e0d1b=f['createInstance'](_0x2c9ed2,_0x3ec0c0);_0x34ae62['push'](_0x2e0d1b);}),_0x34ae62;}[_0x263e('0x88')](_0x2c9ed2,_0x34ae62){return h(this,void 0x0,void 0x0,function*(){if(!0x1===Array[_0x263e('0x80')](_0x2c9ed2)||!0x1===Array[_0x263e('0x80')](_0x34ae62))return[];const _0x3ec0c0=_0x31f1af[_0x263e('0x32')](_0x2c9ed2,'ID'),_0x2e0d1b=_0x31f1af['chain'](_0x34ae62)['map']('ID')[_0x263e('0xba')]()[_0x263e('0x2')](),_0x137f1e=[];for(let _0x2c9ed2=0x0;_0x2c9ed2<_0x3ec0c0['length'];_0x2c9ed2++){const _0x34ae62=_0x3ec0c0[_0x2c9ed2];_0x2e0d1b['indexOf'](_0x34ae62)>-0x1&&_0x137f1e[_0x263e('0x30')](_0x34ae62);}const _0x525873=[];for(let _0x34ae62=0x0;_0x34ae62<_0x137f1e['length'];_0x34ae62++){const _0x3ec0c0=_0x137f1e[_0x34ae62],_0x2e0d1b=_0x31f1af[_0x263e('0x7c')](_0x2c9ed2,{'ID':_0x3ec0c0});_0x2e0d1b&&_0x525873[_0x263e('0x30')](_0x2e0d1b);}return _0x525873;});}[_0x263e('0x7e')](){const _0x2c9ed2=this[_0x263e('0x67')]['getBaseURLInfo']()[_0x263e('0x1f')](_0x263e('0x20'));let _0x34ae62=_0x2c9ed2[0x0];return _0x2c9ed2['length']>0x0&&(_0x34ae62=_0x2c9ed2[0x1]),_0x34ae62;}}class I{constructor(){}static[_0x263e('0xbb')](_0x2c9ed2){const _0x34ae62=_0x3f543a(_0x2c9ed2);return 0x1==isNaN(_0x34ae62[_0x263e('0xbc')]())?_0x2c9ed2:_0x34ae62;}}require(_0x263e('0x5'))[_0x263e('0x6')]();class C{constructor(_0x2c9ed2){this[_0x263e('0xbd')]='',this[_0x263e('0x67')]=null,this[_0x263e('0x7a')]=null,_0x2c9ed2&&_0x2c9ed2[_0x263e('0x74')]?(this[_0x263e('0x67')]=_0x2c9ed2[_0x263e('0x74')],process['env'][_0x263e('0x1b')]&&console[_0x263e('0x12')](_0x263e('0x75'))):this[_0x263e('0x67')]=new g(),_0x2c9ed2&&_0x2c9ed2['MongoServiceInstance']?(this[_0x263e('0x68')]=_0x2c9ed2[_0x263e('0x76')],process['env'][_0x263e('0x1b')]&&console[_0x263e('0x12')](_0x263e('0x77'))):this[_0x263e('0x68')]=S['getInstance'](process[_0x263e('0x17')][_0x263e('0x78')]||'RISPACS'),this[_0x263e('0x7a')]=v[_0x263e('0x73')](this[_0x263e('0x67')],this[_0x263e('0x68')]);}static[_0x263e('0x73')](_0x2c9ed2,_0x34ae62){const _0x3ec0c0=S[_0x263e('0x58')](_0x2c9ed2[_0x263e('0xb6')]);S['setMongoDBConnString'](_0x3ec0c0[_0x263e('0xb7')]);const _0x2e0d1b=S['getInstance'](_0x3ec0c0[_0x263e('0x53')]);return new C({'OrthancRestClientInstance':new g({'orthancBaseURL':_0x34ae62}),'MongoServiceInstance':_0x2e0d1b});}static[_0x263e('0xb8')](_0x2c9ed2){const _0x34ae62=[];return _0x2c9ed2[_0x263e('0xb9')]['forEach'](_0x3ec0c0=>{const _0x2e0d1b=C[_0x263e('0x73')](_0x2c9ed2,_0x3ec0c0);_0x34ae62['push'](_0x2e0d1b);}),_0x34ae62;}[_0x263e('0xbe')](){return this[_0x263e('0x67')][_0x263e('0x1d')]();}[_0x263e('0xbf')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){if(_0x2c9ed2[_0x263e('0xc0')]&&null===_0x2c9ed2['startFrom'])throw new Error(_0x263e('0xc1'));let _0x34ae62={'since':_0x2c9ed2[_0x263e('0xc2')]-0x1,'limit':0x1};const _0x3ec0c0=yield this[_0x263e('0x67')][_0x263e('0x39')](_0x34ae62);for(const _0x34ae62 of _0x3ec0c0[_0x263e('0xc3')]){if(_0x2c9ed2[_0x263e('0xc2')]!==_0x34ae62[_0x263e('0xc4')])return _0x34ae62[_0x263e('0xc5')]=_0x263e('0xc6'),_0x34ae62[_0x263e('0xc7')]=new Date()[_0x263e('0xc8')](),_0x34ae62['ts']=new Date(),_0x34ae62['ID']='NA',_0x34ae62[_0x263e('0xc9')]='NA',_0x34ae62[_0x263e('0xca')]='NA',_0x34ae62[_0x263e('0xc4')]=_0x2c9ed2[_0x263e('0xc2')],yield this[_0x263e('0xcb')](_0x34ae62);yield this['indexChangeItem'](_0x34ae62);}});}[_0x263e('0xcc')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{let _0x3ec0c0=!0x0,_0x2e0d1b=null,_0x137f1e=null,_0x525873=null;const _0x31f1af=yield this[_0x263e('0xcd')]();_0x525873=null===_0x31f1af?0x0:_0x31f1af,_0x2c9ed2&&!0x0===_0x2c9ed2[_0x263e('0xc0')]&&(_0x2e0d1b={'since':_0x31f1af}),m['debug'](_0x263e('0xce')+JSON['stringify'](_0x2e0d1b));let _0x528797=0x1,_0x3f543a=0x0;function _0x34ae62(_0x2c9ed2){return new Promise(_0x34ae62=>{setTimeout(_0x34ae62,_0x2c9ed2);});}for(;_0x3ec0c0;)try{const _0x2c9ed2=yield this['otRestSvc'][_0x263e('0x39')](_0x2e0d1b);for(const _0x34ae62 of _0x2c9ed2[_0x263e('0xc3')])yield this[_0x263e('0xcb')](_0x34ae62),_0x3f543a++;_0x3ec0c0=!this[_0x263e('0xcf')](_0x2c9ed2);let _0x525873=null;_0x3ec0c0&&(_0x2e0d1b={'since':_0x525873=_0x137f1e=this[_0x263e('0xd0')](_0x2c9ed2)},process[_0x263e('0x17')]['INFO']&&m[_0x263e('0x4d')](_0x263e('0xd1'))),m[_0x263e('0x4a')](_0x263e('0xd2')+_0x525873+'\x20LoopCount\x20'+_0x528797+_0x263e('0xd3')+_0x3f543a),_0x528797++;}catch(_0x115197){if(_0x115197['message'][_0x263e('0xd4')]('timeout')>-0x1){console[_0x263e('0xd5')](_0x115197[_0x263e('0x26')],_0x263e('0xd6')),yield _0x34ae62(0x5dc);continue;}throw new Error(_0x115197[_0x263e('0x25')]||_0x115197['message']||_0x115197);}let _0x23e59a=yield this[_0x263e('0xd7')](_0x525873);for(const _0x2c9ed2 of _0x23e59a[_0x263e('0xd8')])yield this[_0x263e('0xbf')]({'startFrom':_0x2c9ed2});if((_0x23e59a=yield this['validateMissingSeqs'](_0x525873))&&0x0===_0x23e59a['missingSeqs'][_0x263e('0x44')]){const _0x2c9ed2={'initialBatchSeq':_0x525873,'lastSeq':_0x23e59a[_0x263e('0xd9')]||_0x525873,'ts':new Date()};yield this[_0x263e('0xda')](_0x2c9ed2,yield this[_0x263e('0x7a')][_0x263e('0xdb')]()),m[_0x263e('0x4a')](_0x263e('0xdc')),m[_0x263e('0x4a')](_0x2c9ed2);}yield this[_0x263e('0x68')][_0x263e('0x65')]();}catch(_0x4fb332){throw new Error(_0x4fb332[_0x263e('0x25')]||_0x4fb332[_0x263e('0x26')]||_0x4fb332);}});}[_0x263e('0xcd')](){return h(this,void 0x0,void 0x0,function*(){let _0x2c9ed2=null;const _0x34ae62=yield this['Collections']['getOrthancStreamCollection']();return _0x2c9ed2=yield _0x34ae62[_0x263e('0x7c')]()[_0x263e('0xdd')]({'Seq':-0x1})['limit'](0x1)[_0x263e('0x7d')](),Array[_0x263e('0x80')](_0x2c9ed2)&&(_0x2c9ed2=_0x2c9ed2[0x0]),_0x2c9ed2&&_0x2c9ed2[_0x263e('0xc4')]?_0x2c9ed2[_0x263e('0xc4')]:null;});}[_0x263e('0xde')](){return h(this,void 0x0,void 0x0,function*(){const _0x2c9ed2=this[_0x263e('0x68')];try{yield _0x2c9ed2[_0x263e('0x63')]();}catch(_0x990d03){}const _0x34ae62=yield this[_0x263e('0x7a')][_0x263e('0x69')](),_0x3ec0c0=yield _0x34ae62[_0x263e('0x7c')]({'ChangeType':_0x263e('0x87')})['toArray']();console['log'](_0x3ec0c0);});}['indexChangeItem'](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){const _0x34ae62=_0x23e59a(_0x2c9ed2[_0x263e('0xc5')]+'_'+_0x2c9ed2['ID']+'_'+_0x2c9ed2[_0x263e('0xc7')]+'_'+_0x2c9ed2[_0x263e('0xc4')]);let _0x3ec0c0=Object['assign']({},_0x2c9ed2);yield this[_0x263e('0xdf')](_0x3ec0c0,_0x34ae62);});}['validateMissingSeqs'](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){const _0x34ae62=yield this[_0x263e('0x7a')]['getOrthancStreamCollection']();let _0x3ec0c0=yield _0x34ae62[_0x263e('0x7c')]({'Seq':{'$gt':_0x2c9ed2}})[_0x263e('0xe0')]({'Seq':0x1,'_id':-0x1})[_0x263e('0xdd')]({'Seq':0x1})[_0x263e('0x7d')]();return{'lastSeq':(_0x3ec0c0=_0x3ec0c0[_0x263e('0x32')](_0x2c9ed2=>_0x2c9ed2[_0x263e('0xc4')]))[_0x3ec0c0['length']-0x1],'missingSeqs':_0x3ec0c0[_0x263e('0xe1')](function(_0x2c9ed2,_0x34ae62,_0x3ec0c0,_0x2e0d1b){var _0x137f1e=_0x34ae62-_0x2e0d1b[_0x3ec0c0-0x1];if(_0x137f1e>0x1)for(var _0x525873=0x1;_0x525873<_0x137f1e;)_0x2c9ed2[_0x263e('0x30')](_0x2e0d1b[_0x3ec0c0-0x1]+_0x525873),_0x525873++;return _0x2c9ed2;},[])};});}[_0x263e('0xda')](_0x2c9ed2,_0x34ae62){return h(this,void 0x0,void 0x0,function*(){for(;;)try{const _0x2e0d1b=_0x34ae62;var _0x3ec0c0=_0x2e0d1b[_0x263e('0x7c')]({})['sort']({'_id':-0x1})[_0x263e('0x3c')](0x1);let _0x137f1e=0x1;if(yield _0x3ec0c0[_0x263e('0xe2')]()){_0x137f1e=(yield _0x3ec0c0[_0x263e('0x4')]())['_id']+0x1;}yield _0x2e0d1b[_0x263e('0x84')](Object[_0x263e('0xe3')]({'_id':_0x137f1e},_0x2c9ed2));break;}catch(_0x283ba2){if(_0x283ba2[_0x263e('0x26')][_0x263e('0xd4')](_0x263e('0xe4'))>-0x1)continue;throw new Error(_0x283ba2['msg']||_0x283ba2['message']||_0x283ba2);}});}['insertNewItem'](_0x2c9ed2,_0x34ae62){return h(this,void 0x0,void 0x0,function*(){const _0x3ec0c0=yield this[_0x263e('0x7a')][_0x263e('0x69')](),_0x2e0d1b=I['convertStringToDate'](_0x2c9ed2[_0x263e('0xc7')]);delete _0x2c9ed2['Date'];try{const _0x137f1e=yield _0x3ec0c0['insertOne'](Object['assign']({'_id':_0x34ae62,'date':_0x2e0d1b,'ts':new Date()},_0x2c9ed2));process[_0x263e('0x17')][_0x263e('0xe5')]&&m[_0x263e('0x4a')](JSON['stringify']({'msg':'ID\x20-\x20'+_0x2c9ed2['ID']+_0x263e('0xe6'),'insertedCount':_0x137f1e[_0x263e('0xe7')]}));}catch(_0x2075da){const _0x3ec0c0='E11000\x20duplicate\x20key\x20error\x20collection';if(!(_0x2075da[_0x263e('0x26')][_0x263e('0xd4')](_0x3ec0c0)>-0x1))throw new Error(_0x2075da);m['info'](_0x263e('0xe8')+_0x34ae62+'\x20at\x20OrthancChangeStream\x20is\x20duplicated\x20-\x20Skipping');}});}[_0x263e('0xcf')](_0x2c9ed2){return Object[_0x263e('0xe9')](_0x2c9ed2)[_0x263e('0xd4')]('Done')>-0x1?_0x2c9ed2[_0x263e('0xdc')]:null;}[_0x263e('0xd0')](_0x2c9ed2){let _0x34ae62=null;if(Array['isArray'](_0x2c9ed2[_0x263e('0xc3')])){const _0x3ec0c0=_0x2c9ed2[_0x263e('0xc3')][_0x2c9ed2['Changes'][_0x263e('0x44')]-0x1];_0x3ec0c0&&(_0x34ae62=_0x3ec0c0['Seq']);}return _0x34ae62;}}require('path');const p=require('fs');require('pino');var D=require(_0x263e('0xea')),w=[{'level':_0x263e('0x4d'),'stream':D[_0x263e('0xeb')]()},{'level':_0x263e('0x4d'),'stream':p[_0x263e('0xec')](_0x263e('0xed'))},{'level':_0x263e('0x4e'),'stream':p[_0x263e('0xec')](_0x263e('0xee'))},{'level':_0x263e('0xd5'),'stream':p[_0x263e('0xec')](_0x263e('0xef'))},{'level':_0x263e('0x4c'),'stream':p[_0x263e('0xec')]('/tmp/fatal.stream.out')}];class O{constructor(){}static[_0x263e('0xf0')](){return D({'streams':w});}}class R{constructor(_0x2c9ed2,_0x34ae62){this['MongoServiceInstance']=null,O[_0x263e('0xf0')]()[_0x263e('0x4e')](_0x263e('0xf1')),this['OrthancServers']=_0x2c9ed2,S[_0x263e('0x54')](_0x34ae62['connString']),this[_0x263e('0x76')]=S[_0x263e('0x27')](_0x34ae62[_0x263e('0x53')]);}[_0x263e('0xf0')](){return O[_0x263e('0xf0')]();}[_0x263e('0xf2')](){return h(this,void 0x0,void 0x0,function*(){try{yield this[_0x263e('0xf3')](this[_0x263e('0xb9')]);}catch(_0xd6f6b3){throw new Error(_0xd6f6b3[_0x263e('0x25')]||_0xd6f6b3['message']||_0xd6f6b3);}});}['load'](){return h(this,void 0x0,void 0x0,function*(){try{yield this[_0x263e('0xf2')](),this[_0x263e('0xf4')]=yield this[_0x263e('0xf5')](this[_0x263e('0xb9')]),this['OrthancDataServiceInstances']=yield this['createOrthancDataServiceInstances'](this['OrthancRestClientInstances']);}catch(_0x24f395){throw new Error(_0x24f395[_0x263e('0x25')]||_0x24f395[_0x263e('0x26')]||_0x24f395);}});}[_0x263e('0xf6')](){return h(this,void 0x0,void 0x0,function*(){try{yield this['load']();const _0x2c9ed2=yield this[_0x263e('0xf7')](this['OrthancRestClientInstances']);yield this[_0x263e('0xf8')](_0x2c9ed2);}catch(_0x25ff5e){throw _0x25ff5e;}});}[_0x263e('0xf5')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{const _0x34ae62=[];for(let _0x3ec0c0=0x0;_0x3ec0c0<_0x2c9ed2[_0x263e('0x44')];_0x3ec0c0++){const _0x2e0d1b=_0x2c9ed2[_0x3ec0c0],_0x137f1e=new g({'orthancBaseURL':_0x2e0d1b});_0x34ae62[_0x263e('0x30')](_0x137f1e);}return _0x34ae62;}catch(_0x38d245){throw new Error(_0x38d245[_0x263e('0x25')]||_0x38d245[_0x263e('0x26')]||_0x38d245);}});}['createOrthancDataServiceInstances'](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{const _0x34ae62=[];for(let _0x3ec0c0=0x0;_0x3ec0c0<_0x2c9ed2[_0x263e('0x44')];_0x3ec0c0++){const _0x2e0d1b=_0x2c9ed2[_0x3ec0c0],_0x137f1e=new f({'MongoServiceInstance':this[_0x263e('0x76')],'OrthancRestClientInstance':_0x2e0d1b});_0x34ae62[_0x263e('0x30')](_0x137f1e);}return _0x34ae62;}catch(_0xfbaf0a){throw new Error(_0xfbaf0a['msg']||_0xfbaf0a['message']||_0xfbaf0a);}});}[_0x263e('0xf7')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{const _0x34ae62=[];for(let _0x3ec0c0=0x0;_0x3ec0c0<_0x2c9ed2[_0x263e('0x44')];_0x3ec0c0++){const _0x2e0d1b=_0x2c9ed2[_0x3ec0c0],_0x137f1e=new C({'MongoServiceInstance':this[_0x263e('0x76')],'OrthancRestClientInstance':_0x2e0d1b});_0x34ae62[_0x263e('0x30')](_0x137f1e);}return _0x34ae62;}catch(_0x1585ab){throw new Error(_0x1585ab[_0x263e('0x25')]||_0x1585ab[_0x263e('0x26')]||_0x1585ab);}});}['getListOfStudiesAllServers'](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{let _0x2c9ed2=[];for(let _0x34ae62=0x0;_0x34ae62<this['OrthancDataServiceInstances'][_0x263e('0x44')];_0x34ae62++){const _0x3ec0c0=this[_0x263e('0xf9')][_0x34ae62],_0x2e0d1b=yield _0x3ec0c0[_0x263e('0xaa')]({'withServerInfo':!0x0});_0x2c9ed2=_0x2c9ed2[_0x263e('0x33')](..._0x2e0d1b);}return _0x2c9ed2;}catch(_0x43e9f8){throw new Error(_0x43e9f8[_0x263e('0x25')]||_0x43e9f8[_0x263e('0x26')]||_0x43e9f8);}});}[_0x263e('0xf8')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{for(let _0x34ae62=0x0;_0x34ae62<_0x2c9ed2[_0x263e('0x44')];_0x34ae62++){const _0x3ec0c0=_0x2c9ed2[_0x34ae62];yield _0x3ec0c0['indexChangeStream']({'resumeIndexing':!0x0});}}catch(_0x33fa58){throw new Error(_0x33fa58[_0x263e('0x25')]||_0x33fa58[_0x263e('0x26')]||_0x33fa58);}});}[_0x263e('0xf3')](_0x2c9ed2){return h(this,void 0x0,void 0x0,function*(){try{let _0x34ae62=0x0;if(Array['isArray'](_0x2c9ed2)){for(let _0x2e0d1b=0x0;_0x2e0d1b<_0x2c9ed2['length'];_0x2e0d1b++){const _0x137f1e=_0x2c9ed2[_0x2e0d1b];(yield _0x3ec0c0(_0x137f1e))&&_0x34ae62++;}return _0x34ae62==_0x2c9ed2[_0x263e('0x44')];}return!0x1;}catch(_0x25a461){console[_0x263e('0xd5')]('Servers:',this[_0x263e('0xb9')]['join'](','),'are\x20not\x20online'),process[_0x263e('0xfa')](0x1);}});}}class M{constructor(_0x2c9ed2){this[_0x263e('0x67')]=null,this[_0x263e('0x7a')]=null,_0x2c9ed2&&_0x2c9ed2[_0x263e('0x74')]&&(this[_0x263e('0x67')]=_0x2c9ed2['OrthancRestClientInstance']),_0x2c9ed2&&_0x2c9ed2['MongoServiceInstance']&&(this[_0x263e('0x68')]=_0x2c9ed2[_0x263e('0x76')]),this[_0x263e('0x7a')]=v[_0x263e('0x73')](this[_0x263e('0x67')],this[_0x263e('0x68')]);}static['createInstance'](_0x2c9ed2,_0x34ae62){const _0x3ec0c0=S[_0x263e('0x58')](_0x2c9ed2['MongoConfig']);S[_0x263e('0x54')](_0x3ec0c0[_0x263e('0xb7')]);const _0x2e0d1b=S[_0x263e('0x27')](_0x3ec0c0['dbName']);return new M({'OrthancRestClientInstance':new g({'orthancBaseURL':_0x34ae62}),'MongoServiceInstance':_0x2e0d1b});}static[_0x263e('0xb8')](_0x2c9ed2){const _0x34ae62=[];return _0x2c9ed2[_0x263e('0xb9')]['forEach'](_0x3ec0c0=>{const _0x2e0d1b=M[_0x263e('0x73')](_0x2c9ed2,_0x3ec0c0);_0x34ae62[_0x263e('0x30')](_0x2e0d1b);}),_0x34ae62;}[_0x263e('0xfb')](){return h(this,void 0x0,void 0x0,function*(){try{const _0x34ae62=yield this[_0x263e('0x7a')][_0x263e('0x6d')](),_0x3ec0c0=yield _0x34ae62[_0x263e('0x7c')]()[_0x263e('0xdd')]({'Seq':-0x1})[_0x263e('0x3c')](0x1)[_0x263e('0x7d')]();let _0x2e0d1b=0x0==_0x3ec0c0[_0x263e('0x44')]?0x0:_0x3ec0c0[0x0][_0x263e('0xc4')];const _0x137f1e=yield this[_0x263e('0x7a')][_0x263e('0xdb')](),_0x525873=yield _0x137f1e[_0x263e('0x7c')]({'lastSeq':{'$gt':_0x2e0d1b}})[_0x263e('0xdd')]({'_id':0x1})[_0x263e('0x7d')]();let _0x31f1af=0x0,_0x528797=null;_0x525873[_0x263e('0x44')]>0x0&&(_0x31f1af=_0x2e0d1b,_0x528797=_0x525873[_0x525873[_0x263e('0x44')]-0x1][_0x263e('0xd9')]);const _0x3f543a=yield this[_0x263e('0x7a')][_0x263e('0x69')](),_0x23e59a=[];_0x23e59a['push']({'Seq':{'$gt':_0x31f1af}}),null!==_0x528797&&_0x23e59a['push']({'Seq':{'$lte':_0x528797}});const _0x14312d=yield _0x3f543a[_0x263e('0x7c')]({'ChangeType':_0x263e('0xfc'),'$and':_0x23e59a})[_0x263e('0xdd')]({'Seq':0x1})[_0x263e('0xe0')]({'ID':0x1,'Seq':0x1});let h=null;const u=yield _0x14312d[_0x263e('0xfd')]();let g=0x0;for(;yield _0x14312d[_0x263e('0xe2')]();)try{let _0x3ec0c0=null!==h?h:yield _0x14312d[_0x263e('0x4')]();h=_0x3ec0c0;const _0x2e0d1b=_0x3ec0c0['ID'],_0x137f1e=_0x3ec0c0[_0x263e('0xc4')],_0x525873=yield this[_0x263e('0x67')][_0x263e('0x27')](_0x2e0d1b,{'useCache':!0x1}),_0x31f1af=yield this[_0x263e('0x67')][_0x263e('0xfe')](_0x2e0d1b,{'useCache':!0x1}),_0x528797=yield this['otRestSvc'][_0x263e('0x46')](_0x2e0d1b),_0x23e59a={};if(_0x528797)for(const [_0x2c9ed2,_0x34ae62]of Object['entries'](_0x528797)){const _0x3ec0c0=Object['assign']({'dicomCode':_0x2c9ed2},_0x34ae62);_0x23e59a[_0x34ae62['Name']]=_0x3ec0c0;}const m=(yield _0x3f543a[_0x263e('0x7c')]({'ID':_0x2e0d1b})['toArray']())[0x0],S=Object[_0x263e('0xe3')]({'_id':_0x2e0d1b,'ts':new Date(),'Seq':_0x137f1e,'dateArrived':m[_0x263e('0xff')],'dateIndexed':m['ts'],'md5Hash':_0x31f1af,'AccessionNumber':_0x23e59a[_0x263e('0x8b')]?_0x23e59a[_0x263e('0x8b')][_0x263e('0x100')]:_0x263e('0x101'),'dicomAsJson':_0x23e59a},_0x525873);console[_0x263e('0x12')](++g+_0x263e('0x102')+u+_0x263e('0x49')+S['ID']),yield _0x34ae62['insertOne'](S),h=null;}catch(_0x241c1f){function _0x2c9ed2(_0x2c9ed2){return new Promise(_0x241c1f=>{setTimeout(_0x241c1f,_0x2c9ed2);});}if(_0x241c1f[_0x263e('0x26')][_0x263e('0xd4')](_0x263e('0xa'))>-0x1){console[_0x263e('0xd5')](_0x241c1f['message'],_0x263e('0xd6')),yield _0x2c9ed2(0x5dc);continue;}throw new Error(_0x241c1f[_0x263e('0x25')]||_0x241c1f[_0x263e('0x26')]||_0x241c1f);}console['log'](_0x263e('0x103'));}catch(_0x46d435){throw new Error(_0x46d435[_0x263e('0x25')]||_0x46d435[_0x263e('0x26')]||_0x46d435);}});}[_0x263e('0x104')](){return h(this,void 0x0,void 0x0,function*(){try{const _0x34ae62=yield this['Collections'][_0x263e('0x105')](),_0x3ec0c0=yield _0x34ae62[_0x263e('0x7c')]()[_0x263e('0xdd')]({'Seq':-0x1})[_0x263e('0x3c')](0x1)[_0x263e('0x7d')]();let _0x2e0d1b=0x0==_0x3ec0c0[_0x263e('0x44')]?0x0:_0x3ec0c0[0x0][_0x263e('0xc4')];const _0x137f1e=yield this[_0x263e('0x7a')]['getIndexBatchCol'](),_0x525873=yield _0x137f1e[_0x263e('0x7c')]({'lastSeq':{'$gt':_0x2e0d1b}})[_0x263e('0xdd')]({'_id':0x1})[_0x263e('0x7d')]();let _0x31f1af=0x0,_0x528797=null;_0x525873['length']>0x0&&(_0x31f1af=_0x2e0d1b,_0x528797=_0x525873[_0x525873[_0x263e('0x44')]-0x1][_0x263e('0xd9')]);const _0x3f543a=yield this[_0x263e('0x7a')][_0x263e('0x69')](),_0x23e59a=[];_0x23e59a[_0x263e('0x30')]({'Seq':{'$gt':_0x31f1af}}),null!==_0x528797&&_0x23e59a[_0x263e('0x30')]({'Seq':{'$lte':_0x528797}});const _0x14312d=yield _0x3f543a[_0x263e('0x7c')]({'ChangeType':'NewSeries','$and':_0x23e59a})['sort']({'Seq':0x1})[_0x263e('0xe0')]({'ID':0x1,'Seq':0x1});let h=null;const u=yield _0x14312d['count']();let g=0x0;for(;yield _0x14312d[_0x263e('0xe2')]();)try{let _0x3ec0c0=null!==h?h:yield _0x14312d[_0x263e('0x4')]();h=_0x3ec0c0;const _0x2e0d1b=_0x3ec0c0['ID'],_0x137f1e=_0x3ec0c0[_0x263e('0xc4')],_0x525873=yield this['otRestSvc'][_0x263e('0x2b')](_0x2e0d1b,{'useCache':!0x1}),_0x31f1af=(yield _0x3f543a[_0x263e('0x7c')]({'ID':_0x2e0d1b})[_0x263e('0x7d')]())[0x0],_0x528797=Object[_0x263e('0xe3')]({'_id':_0x2e0d1b,'ts':new Date(),'Seq':_0x137f1e,'dateArrived':_0x31f1af[_0x263e('0xff')],'dateIndexed':_0x31f1af['ts']},_0x525873);console[_0x263e('0x12')](++g+_0x263e('0x102')+u+_0x263e('0x49')+_0x528797['ID']),yield _0x34ae62['insertOne'](_0x528797),h=null;}catch(_0x2d4770){function _0x2c9ed2(_0x2c9ed2){return new Promise(_0x2d4770=>{setTimeout(_0x2d4770,_0x2c9ed2);});}if(_0x2d4770[_0x263e('0x26')]['indexOf'](_0x263e('0xa'))>-0x1){console['error'](_0x2d4770[_0x263e('0x26')],_0x263e('0xd6')),yield _0x2c9ed2(0x5dc);continue;}throw new Error(_0x2d4770[_0x263e('0x25')]||_0x2d4770[_0x263e('0x26')]||_0x2d4770);}console[_0x263e('0x12')](_0x263e('0x103'));}catch(_0x74adc8){throw new Error(_0x74adc8['msg']||_0x74adc8[_0x263e('0x26')]||_0x74adc8);}});}['indexPrometheus'](){return h(this,void 0x0,void 0x0,function*(){try{const _0x2c9ed2=(yield this[_0x263e('0x67')]['getPrometheusMetrics']())['split']('\x0a'),_0x34ae62=[];for(const _0x3ec0c0 of _0x2c9ed2){const _0x2c9ed2=_0x3ec0c0[_0x263e('0x1f')]('\x20');if(!0x1===Array[_0x263e('0x80')](_0x2c9ed2)||0x0===_0x2c9ed2[_0x263e('0x44')]||''===_0x2c9ed2[0x0])continue;const _0x2e0d1b={'_id':_0x2c9ed2[0x0],'metric':_0x2c9ed2[0x0],'value':+_0x2c9ed2[0x1],'ts':new Date(+_0x2c9ed2[0x2])};_0x34ae62[_0x263e('0x30')](_0x2e0d1b);}const _0x3ec0c0=yield this[_0x263e('0x7a')][_0x263e('0x71')]();for(const _0x2c9ed2 of _0x34ae62)try{yield _0x3ec0c0[_0x263e('0x84')](_0x2c9ed2);}catch(_0x5d994b){if(0x2af8===_0x5d994b[_0x263e('0x106')])continue;}console[_0x263e('0x12')](_0x2c9ed2);}catch(_0x28974b){throw new Error(_0x28974b[_0x263e('0x25')]||_0x28974b['message']||_0x28974b);}});}}class N{[_0x263e('0x107')](_0x2c9ed2,_0x34ae62){return new Promise((_0x3ec0c0,_0x2e0d1b)=>{_0x14312d[_0x263e('0x108')](_0x2c9ed2,_0x34ae62,function(_0x2c9ed2){_0x2c9ed2&&_0x2e0d1b(_0x2c9ed2),_0x3ec0c0(!0x0);});});}}export{m as ConsoleLoggingService,N as FileUtils,M as InstancesIndexingService,O as LogginService,S as MongoDBService,C as OrthancDataIndexService,f as OrthancDataService,R as OrthancMainService,g as OrthancRestClient};
